<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Introduction to neurons and neuronlists &bull; nat</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">nat</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/jefferis/nat">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Introduction to neurons and neuronlists</h1>
                        <h4 class="author">Gregory Jefferis</h4>
            
            <h4 class="date">2016-11-08</h4>
          </div>

    
    
<div class="contents">
<div id="preface" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#preface" class="anchor"> </a></body></html>Preface</h2>
<p>This vignette is designed to give you a good introduction to some of the key features of nat by teaching you about how it handles individual neurons and collections of neurons.</p>
<p>The source code for this vignette is available at <a href="https://github.com/jefferis/nat/blob/master/vignettes/neurons-intro.Rmd" class="uri">https://github.com/jefferis/nat/blob/master/vignettes/neurons-intro.Rmd</a>. If you find something unclear or notice a typo, I would be very happy if you would click on the Pencil Icon on that page or follow <a href="https://github.com/jefferis/nat/edit/master/vignettes/neurons-intro.Rmd">this link to edit</a> and suggest an alternative wording. Don&rsquo;t be shy about doing this; I have to review any change and even if your suggestion is not perfect it will still be a prompt for me to improve this document. Thank you!</p>
</div>
<div id="startup" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#startup" class="anchor"> </a></body></html>Startup</h2>
<p>Install the package if required</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">'nat'</span>, <span class="dt">dependencies =</span> <span class="ot">TRUE</span>)</code></pre>
<p>Load the package</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(nat)</code></pre>
</div>
<div id="neurons-and-neuronlists" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#neurons-and-neuronlists" class="anchor"> </a></body></html>Neurons and Neuronlists</h2>
<p>There are a number of basic built in types of data in R such as vectors and matrices, but it is also very easy to define new data types with specialised features to enable powerful and efficient analysis of particular kinds of data. These specialised data types are called <em>classes</em> and a specific instance of a class is an <em>object</em> (a neuroscience analogy: this is the difference between talking about the general class of mitral cells and the specific cell that you just sealed onto with your patch clamp electrode.)</p>
<p>We will look at two key classes that <strong>nat</strong> defines for handling 3D structures of neurons</p>
<ul><li><code>neuron</code></li>
<li><code>neuronlist</code></li>
</ul><div id="sample-data" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#sample-data" class="anchor"> </a></body></html>Sample Data</h3>
<p>As an example we&rsquo;re going to look at a data set of olfactory projection neurons originally published as Supplemental Information to accompany <a href="http://dx.doi.org/10.1016/j.cell.2007.01.040">Jefferis, Potter et al, Cell (2007)</a>. A subset of the original data are distributed as a sample data object with the <strong>nat</strong> package, which we can load like so.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">"Cell07PNs"</span>)</code></pre>
<p>For more information about these data see <a href="http://jefferis.github.io/nat/reference/Cell07PNs.html">Cell07PNs</a>.</p>
<p>This <code>Cell07PNs</code> object has two classes <code>neuronlist</code> and the base class <code>list</code></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(Cell07PNs)</code></pre>
<pre><code>## [1] "neuronlist" "list"</code></pre>
<p>Many R objects inherit from the base class <code>list</code> (objects can have multiple classes in the same way that a mitral cell is also neuron) because this is a convenient container class into which you can put a variety of different kinds of data. In this case the <code>Cell07PNs</code> <code>neuronlist</code> contains 40 objects:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(Cell07PNs)</code></pre>
<pre><code>## [1] 40</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># access the first neuron in the neuronlist</span>
<span class="kw">class</span>(Cell07PNs[[<span class="dv">1</span>]])</code></pre>
<pre><code>## [1] "neuron" "list"</code></pre>
<p>each representing a traced neuron. We will now look in detail at these two classes.</p>
</div>
</div>
<div id="neurons" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#neurons" class="anchor"> </a></body></html>Neurons</h2>
<p>We start by extracting the first neuron in Cell07PNs, and assigning it to a variable. We can then plot the neuron so that we have an image of what we are talking about.</p>
<pre class="sourceCode r"><code class="sourceCode r">n1=Cell07PNs[[<span class="dv">1</span>]]
<span class="kw">plot</span>(n1)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
<div id="neuron-internal-structure" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#neuron-internal-structure" class="anchor"> </a></body></html>Neuron internal structure</h3>
<p>The <code>str</code> function (short for structure) allows us to take a look at the internal structure of this neuron object.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Use =1 so that we don't show complete structure</span>
<span class="co"># for objects inside n1</span>
<span class="kw">str</span>(n1, <span class="dt">max.level=</span><span class="dv">1</span>)</code></pre>
<pre><code>## List of 24
##  $ CellType     : chr "DA1"
##  $ NeuronName   : chr "EBH11R"
##  $ InputFileName:Class 'AsIs'  chr "/GD/projects/PN2/TransformedTraces/DA1/EBH11R.tasc"
##  $ CreatedAt    : POSIXt[1:1], format: "2006-01-17 15:21:14"
##  $ NodeName     : Named chr "jefferis.joh.cam.ac.uk"
##   ..- attr(*, "names")= chr "nodename"
##  $ InputFileStat:'data.frame':   1 obs. of  10 variables:
##  $ InputFileMD5 : Named chr "fcacee3f874cbe2c6ad96214e6fee337"
##   ..- attr(*, "names")=Class 'AsIs'  chr "/GD/projects/PN2/TransformedTraces/DA1/EBH11R.tasc"
##  $ NumPoints    : int 180
##  $ StartPoint   : num 1
##  $ BranchPoints : num [1:16] 34 48 51 75 78 95 98 99 108 109 ...
##  $ EndPoints    : num [1:18] 1 42 59 62 80 85 96 100 102 112 ...
##  $ NumSegs      : int 33
##  $ SegList      :List of 33
##  $ d            :'data.frame':   180 obs. of  7 variables:
##  $ OrientInfo   :List of 5
##  $ SegOrders    : num [1:33] 1 2 2 3 4 4 3 4 5 5 ...
##  $ MBPoints     : int [1:2] 34 48
##  $ LHBranchPoint: int 75
##  $ SegTypes     : num [1:33] 1 3 1 3 3 3 1 2 2 2 ...
##  $ AxonSegNos   :List of 3
##  $ LHSegNos     : num [1:26] 8 9 10 11 12 13 14 15 16 17 ...
##  $ MBSegNos     :List of 2
##  $ NumMBBranches: num 2
##  $ AxonLHEP     : num 72
##  - attr(*, "class")= chr [1:2] "neuron" "list"</code></pre>
<p>From this you can see that there are a large number of fields inside the neuron. Each field can be accessed using the <code>$</code> or <code>[[</code> operators</p>
<pre class="sourceCode r"><code class="sourceCode r">n1$NumPoints</code></pre>
<pre><code>## [1] 180</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">n1[[<span class="st">"NumPoints"</span>]]</code></pre>
<pre><code>## [1] 180</code></pre>
<p>There are a set of core fields (described in <code><a href="../reference/neuron.html">?neuron</a></code> documentation); the key ones will be described shortly. However there are also quite a few user fields in this neuron and you can safely add any field you like so long as its name does not clash with an existing field. For example:</p>
<pre class="sourceCode r"><code class="sourceCode r">n1$Comment=<span class="st">'The sex of this specimen is uncertain'</span></code></pre>
<p>The single most important field in a neuron is the <code>$d</code> <code>data.frame</code>. This contains a block of data closely reminiscent of the SWC data format for traced neurons:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(n1$d)</code></pre>
<pre><code>## 'data.frame':    180 obs. of  7 variables:
##  $ PointNo: int  1 2 3 4 5 6 7 8 9 10 ...
##  $ Label  : num  2 2 2 2 2 2 2 2 2 2 ...
##  $ X      : num  187 187 188 188 188 ...
##  $ Y      : num  133 131 130 129 129 ...
##  $ Z      : num  88.2 90.6 93.1 95 97.5 ...
##  $ W      : num  1.01 1.27 1.14 1.27 1.27 1.27 1.27 1.27 1.27 1.27 ...
##  $ Parent : num  -1 1 2 3 4 5 6 7 8 9 ...</code></pre>
<p>Each row defines a node in a branched tree with a unique integer identifier, <code>PointNo</code>, normally but not always sequentially numbered from 1. The <code>X,Y,Z</code> columns encode the position of each vertex and the <code>W</code> column encodes the diameter of the neurite at that position.</p>
</div>
<div id="methods-for-neurons" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#methods-for-neurons" class="anchor"> </a></body></html>Methods for neurons</h3>
<p>R&rsquo;s simple <a href="http://adv-r.had.co.nz/OO-essentials.html">S3 object oriented system</a> allows specialised functions for particular classes to be defined. These functions tailored to a particular class are called <em>methods</em>. Methods can be provided for pre-existing functions supplied with base R as well as new user-written functions. The system is quite simple. If a function <code>foo</code> is defined as a <em>generic</em> function then you can define new functions called <code>foo.bar</code> that will be called when you write <code>foo(x)</code> and <code>x</code> has class `bar.</p>
<p>We already used one such method without comment, <code>plot.neuron</code>. There is a base R function called <code>plot</code>. nat defines a new function called <code>plot.neuron</code>, which R interprets as a <code>plot</code> method specialised for <code>neuron</code> objects. When the base R <code>plot</code> function is called, it looks at the class of its first object to see whether a specialised method exists. If there is none, it will use a fallback method called <code>plot.default</code>.</p>
<p>The <code>plot.neuron</code> method interprets the branching structure of a neuron and draws line segments joining up the connected nodes at the appropriate 2D positions. You can compare it with what you would get if you just plotted the XY position of all nodes joined together by a single line:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(n1$d$X, n1$d$Y, <span class="dt">type =</span> <span class="st">'l'</span>)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
<p>You can find out what methods are available for a particular class like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">'neuron'</span>)</code></pre>
<pre><code>##  [1] -                  *                  /                 
##  [4] +                  all.equal          as.neuron         
##  [7] as.ngraph          as.seglist         boundingbox       
## [10] branchpoints       dotprops           endpoints         
## [13] ndigest            plot               plot3d            
## [16] potential_synapses prune              resample          
## [19] rootpoints         scale              subset            
## [22] summary            write.vtk          xform             
## [25] xyzmatrix          xyzmatrix&lt;-       
## see '?methods' for accessing help and source code</code></pre>
<p>You can then find the help page for any method in the console with <code><a href="../reference/plot.neuron.html">?plot.neuron</a></code>. Note that if you write <code>?plot</code> you will get the documentation for the basic <code>plot</code> function supplied with R.</p>
<p>It is also good idea to look at <a href="http://jefferis.github.io/nat/reference/index.html">nat&rsquo;s function reference page</a> which groups available functions into categories that often reflect the class of object they can work on.</p>
<p>In R, operators such as <code>*</code> or <code>+</code> are actually special functions with two arguments, so one can add methods for these in the same way. In the following example we use this arithmetic to shift a neuron by a small amount:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(n1, <span class="dt">col =</span> <span class="st">'black'</span>, <span class="dt">WithNodes =</span> F, <span class="dt">main=</span><span class="st">"Shifting neurons"</span>)
<span class="co"># shift by 3 microns in x,y,z</span>
<span class="kw">plot</span>(n1<span class="dv">+3</span>, <span class="dt">col =</span> <span class="st">'red'</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">WithNodes =</span> F)
<span class="co"># shift by -5 microns in y</span>
<span class="kw">plot</span>(n1+<span class="kw">c</span>(<span class="dv">0</span>,-<span class="dv">5</span>,<span class="dv">0</span>), <span class="dt">col =</span> <span class="st">'blue'</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">WithNodes =</span> F)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-13-1.png" width="480"></p>
<p>Another specialised method is <code>subset.neuron</code> which we can use to extract part of a neuron into a new object. For example, a simple spatial criterion, X location must be &gt;240, is used to extract the axon terminal arborisation field in this example</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(n1, <span class="dt">col =</span> <span class="st">'black'</span>, <span class="dt">WithAllPoints =</span> T, <span class="dt">main=</span><span class="st">"Subsetting a neuron"</span>)
<span class="co"># keep only nodes with X position &gt;20</span>
n1.lh=<span class="kw"><a href="../reference/subset.html">subset</a></span>(n1, X&gt;<span class="dv">240</span>)
<span class="co"># plot the selected part of the neuron in blue</span>
<span class="kw">plot</span>(n1.lh, <span class="dt">col=</span><span class="st">'blue'</span>, <span class="dt">lwd=</span><span class="dv">3</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)
<span class="co"># add a line illustrating the cut point</span>
<span class="kw">abline</span>(<span class="dt">v=</span><span class="dv">240</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-14-1.png" width="480"></p>
<p>We can also summarise the morphological properties of a neuron using the <code>summary.neuron</code> method, which allows us to compare measurements for the original neuron and the axon arbour that we just cut out above.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/summary.neuronlist.html">summary</a></span>(n1)</code></pre>
<pre><code>##   root nodes segments branchpoints endpoints cable.length
## 1    1   180       33           16        18     297.1763</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/summary.neuronlist.html">summary</a></span>(n1.lh)</code></pre>
<pre><code>##   root nodes segments branchpoints endpoints cable.length
## 1    1   111       27           13        15     156.7654</code></pre>
<p>See <a href="http://jefferis.github.io/nat/reference/index.html">nat&rsquo;s function reference page</a> for additional functions for working with neurons.</p>
</div>
</div>
<div id="neuronlists" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#neuronlists" class="anchor"> </a></body></html>Neuronlists</h2>
<p>The <code>data</code> statement above loaded a <code>neuronlist</code> object called <code>Cell07PNs</code> containing 40 <code>neuron</code> objects. <code>neuronlist</code> objects are key data structures in nat for convenient handling of collections of neurons.</p>
<div class="figure">
<img src="fig/neuronlist-01.png" alt="Structure of neuronlist objects"><p class="caption">Structure of neuronlist objects</p>
</div>
<p>The diagram above presents the structure of a neuronlist, <code>x</code>, which contains 5 neurons. The main structure is an R <code>list</code> object, which in this case contains 5 slots. Each slot contains a neuron with a unique name. In addition to this list of neurons there is an optional attached <code>data.frame</code> (another standard R class). When present, each neuron in the main list must have a matching row in this <code>data.frame</code>.</p>
<p>Neuronlists can be manipulated use the square bracket subscript operator to extract or replace a subset of their elements. Crucially when this happens the corresponding rows of the attached metadata are also selected as diagrammed for the result of x[1:3] (right hand side of figure above).</p>
<p>When subscripting any list in R, it is very important to understand the difference between using the single and double bracket operator. We can illustrate this difference as follows:</p>
<div class="figure">
<img src="fig/neuronlist-subsets-01.png" alt="The difference between single and double bracket subscript operators"><p class="caption">The difference between single and double bracket subscript operators</p>
</div>
<p>The single bracket operator makes a new list containing a specified subset of elements in the original list, while the double bracket operator extracts the object at the given position. So in the figure <code>x[1]</code> is a <code>neuronlist</code> object of length 1, whereas <code>x[[1]]</code> is the <code>neuron</code> object at the first position in the list.</p>
<div id="worked-examples" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#worked-examples" class="anchor"> </a></body></html>Worked Examples</h3>
<p>Let us start by extracting the first five neurons from our sample data.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># we can select neurons by indexing </span>
first5=Cell07PNs[<span class="dv">1</span>:<span class="dv">5</span>]
<span class="kw"><a href="../reference/summary.neuronlist.html">summary</a></span>(first5)</code></pre>
<pre><code>##        root nodes segments branchpoints endpoints cable.length
## EBH11R    1   180       33           16        18     297.1763
## EBH20L    1   200       26           12        15     327.0929
## EBH20R    1   199       25           12        14     347.6153
## EBI12L    1   169       23           11        13     294.4680
## EBI22R    1   160       27           13        15     303.0150</code></pre>
<p>Each neuron in the neuronlist has an associated name which can be used to select it. We can get the names of all neurons using the <code>names</code> function.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(Cell07PNs)</code></pre>
<pre><code>##  [1] "EBH11R" "EBH20L" "EBH20R" "EBI12L" "EBI22R" "EBJ23L" "EBJ3R" 
##  [8] "EBN19L" "EBO15L" "EBO53L" "ECA34L" "ECB3L"  "LI23L"  "LIC2R" 
## [15] "LJ5L"   "MC3B"   "MH16L"  "MM14L"  "NA7L"   "NH15L"  "NH29B" 
## [22] "NI16L"  "NIA8L"  "NIA8R"  "NNA9L"  "NNC4R"  "NNE1L"  "OFD2L" 
## [29] "OKC9R"  "SDD8L"  "SH21L"  "SL20L"  "TKC8R"  "TL4R"   "TS7L"  
## [36] "TT27R"  "VA15R"  "VA20R"  "VB37L"  "VB58L"</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">nl3=Cell07PNs[<span class="kw">c</span>(<span class="st">"EBH11R"</span>, <span class="st">"EBH20L"</span>, <span class="st">"EBH20R"</span>)]
<span class="kw">all.equal</span>(nl3, Cell07PNs[<span class="dv">1</span>:<span class="dv">3</span>])</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>You can also use the <code>$</code> operator to access a single neuron e.g. <code>Cell07PNs$EBH11R</code>. This can be quite useful when working interactively in the console because RStudio will offer to autocomplete the neuron name when you start typing past the <code>$</code> symbol, but is not recommended for scripts.</p>
</div>
<div id="metadata" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#metadata" class="anchor"> </a></body></html>Metadata</h3>
<p>The names of neurons are also used to index a <code>data.frame</code> object attached to the neuronlist with one row for each neuron. You can use the <code>head</code> function to give a summary of the attached metadata in this neuronlist. Using the <code>as.data.frame</code> method on a neuronlist allows you to extract this attached metadata to a separate object.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/neuronlist-dataframe-methods.html">head</a></span>(Cell07PNs)</code></pre>
<pre><code>##         Brain RegistrationScore Notes Glomerulus Batch Directory Traced
## EBH11R EBH11R                 4              DA1   PN2    unsure    yes
## EBH20L EBH20L                 4              DL3   PN2   unsure2    yes
## EBH20R EBH20R                 4              DA1   PN2   unsure2    yes
## EBI12L EBI12L                 4              DA1   PN2   unsure3    yes
## EBI22R EBI22R                 4              DL3   PN2   unsure3    yes
## EBJ23L EBJ23L                 4              DL3   PN2   unsure4    yes
##        Scored.By Sex Include     ID HaveWarp HaveAsc
## EBH11R       ACH   M         EBH11R     TRUE    TRUE
## EBH20L       ACH             EBH20L     TRUE    TRUE
## EBH20R       ACH   M         EBH20R     TRUE    TRUE
## EBI12L       ACH   F         EBI12L     TRUE    TRUE
## EBI22R       ACH             EBI22R     TRUE    TRUE
## EBJ23L       ACH             EBJ23L     TRUE    TRUE
##                                                 TraceFile AscBatch Status
## EBH11R /GD/projects/PN2/TransformedTraces/DA1/EBH11R.tasc      New       
## EBH20L /GD/projects/PN2/TransformedTraces/DL3/EBH20L.tasc      New       
## EBH20R /GD/projects/PN2/TransformedTraces/DA1/EBH20R.tasc      New       
## EBI12L /GD/projects/PN2/TransformedTraces/DA1/EBI12L.tasc      New       
## EBI22R /GD/projects/PN2/TransformedTraces/DL3/EBI22R.tasc      New       
## EBJ23L /GD/projects/PN2/TransformedTraces/DL3/EBJ23L.tasc      New       
##        GlomSeq NumNAs MBP1 MBP2 LHBP PNType Seq nTrees StartPoint
## EBH11R       1      0   34   48   75    iPN  13      1          1
## EBH20L       1      0   29   29   77    iPN  15      1          1
## EBH20R       2      0   24   80  147    iPN  16      1          1
## EBI12L       3      0   29   59   89    iPN  18      1          1
## EBI22R       2      0   34   34   56    iPN  20      1          1
## EBJ23L       3      0   23   23   52    iPN  21      1          1
##                  CreatedAt
## EBH11R 2006-01-17 15:21:14
## EBH20L 2006-01-17 15:21:14
## EBH20R 2006-01-17 15:21:14
## EBI12L 2006-01-17 15:21:15
## EBI22R 2006-01-17 15:21:15
## EBJ23L 2006-01-17 15:21:15
##                                                                                             WarpFile
## EBH11R  /GD/projects/PN2/allreg/warp/unsure/average-goodbrains_EBH11R101_warp_m0g40c4e1e-1x16r3.list
## EBH20L /GD/projects/PN2/allreg/warp/unsure2/average-goodbrains_EBH20L101_warp_m0g40c4e1e-1x16r3.list
## EBH20R /GD/projects/PN2/allreg/warp/unsure2/average-goodbrains_EBH20R101_warp_m0g40c4e1e-1x16r3.list
## EBI12L /GD/projects/PN2/allreg/warp/unsure3/average-goodbrains_EBI12L101_warp_m0g40c4e1e-1x16r3.list
## EBI22R /GD/projects/PN2/allreg/warp/unsure3/average-goodbrains_EBI22R101_warp_m0g40c4e1e-1x16r3.list
## EBJ23L /GD/projects/PN2/allreg/warp/unsure4/average-goodbrains_EBJ23L101_warp_m0g40c4e1e-1x16r3.list</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df=<span class="kw">as.data.frame</span>(Cell07PNs)
<span class="kw">nrow</span>(df)</code></pre>
<pre><code>## [1] 40</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># rownames of data.frame are the same as names of Cell07PNs list.</span>
<span class="kw">all.equal</span>(<span class="kw">rownames</span>(df), <span class="kw">names</span>(Cell07PNs))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>You can use columns in the attached metadata in expressions that select or operate on the neurons in the list. In the next two examples we</p>
<ul><li><code>subset</code> the neurons in a neuronlist based on a metadata column</li>
<li>use the <code>with</code> function to carry out a calculation using column(s) of metadata.</li>
</ul><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># subset.neuronlist method (which you call using the subset function)</span>
da1n=<span class="kw"><a href="../reference/subset.html">subset</a></span>(Cell07PNs, Glomerulus==<span class="st">"DA1"</span>)

<span class="co"># with.neuronlist method</span>
<span class="kw"><a href="../reference/neuronlist-dataframe-methods.html">with</a></span>(Cell07PNs, <span class="kw">table</span>(Glomerulus))</code></pre>
<pre><code>## Glomerulus
##  DA1  DL3 DP1m VA1d 
##   11   10    8   11</code></pre>
<p>There is a second approach to accessing this attached metadata data.frame, using the square bracket operator with two arguments as used for subscripting (2D) matrices or <code>data.frames</code>. For example we can access the <code>Glomerulus</code> column like so:</p>
<pre class="sourceCode r"><code class="sourceCode r">Cell07PNs[, <span class="st">'Glomerulus'</span>]</code></pre>
<pre><code>##  [1] DA1  DL3  DA1  DA1  DL3  DL3  VA1d VA1d VA1d VA1d DP1m DP1m DA1  DL3 
## [15] VA1d VA1d DL3  DA1  DA1  VA1d VA1d VA1d DL3  VA1d DP1m DP1m DP1m DP1m
## [29] DP1m DP1m DA1  DL3  DL3  DL3  VA1d DA1  DA1  DA1  DL3  DA1 
## Levels: DA1 DL3 DP1m VA1d</code></pre>
<p>This approach has some features that make for additional flexibility. For example you can acess the whole data.frame like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/summary.neuronlist.html">summary</a></span>(Cell07PNs[,])</code></pre>
<p>The form <code>[,]</code> which includes a comma implies two (missing) arguments. <strong>nat</strong> therefore interprets this as request for the 2D data.frame attached to Cell07PNs rather than the neuronlist itself. You can also use this notation to add new columns or modify existing columns in place.</p>
<pre class="sourceCode r"><code class="sourceCode r">Cell07PNs[, <span class="st">'NewColumn'</span>] =<span class="st"> </span>somevariable
Cell07PNs[, <span class="st">"Sex"</span>] =<span class="st"> </span><span class="kw">sub</span>(<span class="st">"F"</span>, <span class="st">"female"</span>, Cell07PNs[, <span class="st">"Sex"</span>])
Cell07PNs[, <span class="st">"Sex"</span>] =<span class="st"> </span><span class="kw">sub</span>(<span class="st">"M"</span>, <span class="st">"male"</span>, Cell07PNs[, <span class="st">"Sex"</span>])</code></pre>
<p>You can also access selected rows of the data.frame in the normal way:</p>
<pre class="sourceCode r"><code class="sourceCode r">Cell07PNs[<span class="dv">1</span>:<span class="dv">5</span>, <span class="st">"Glomerulus"</span>]
Cell07PNs[Cell07PNs[, <span class="st">"Sex"</span>]==<span class="st">"F"</span>, <span class="st">"Glomerulus"</span>]</code></pre>
</div>
<div id="working-on-all-the-neurons-in-a-neuronlist" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#working-on-all-the-neurons-in-a-neuronlist" class="anchor"> </a></body></html>Working on all the neurons in a neuronlist</h3>
<p>There are quite a few methods defined for the <code>neuronlist</code> class:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">"neuronlist"</span>)</code></pre>
<pre><code>##  [1] -                  [                  [&lt;-               
##  [4] *                  /                  +                 
##  [7] as.data.frame      as.neuronlistfh    c                 
## [10] data.frame&lt;-       dimnames           dotprops          
## [13] droplevels         head               intersect         
## [16] mirror             plot               plot3d            
## [19] potential_synapses prune              setdiff           
## [22] subset             summary            tail              
## [25] union              with               xform             
## [28] xyzmatrix         
## see '?methods' for accessing help and source code</code></pre>
<p>For example we can scale the position (and diameter) of all of the neurons in a neuronlist using the <code>*</code> operator:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># convert from microns to nm</span>
Cell07PNs.nm =<span class="st"> </span>Cell07PNs*<span class="fl">1e3</span>
<span class="kw">plot</span>(Cell07PNs.nm)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-25-1.png" width="480"></p>
<p>There is also a more powerful <code>xform</code> function that allows arbitrary transformations to be applied. For example here we apply a 3D rotation expressed as a homogeneous affine matrix:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define a 180 degree rotation around the x axis</span>
rotm=<span class="kw"><a href="../reference/cmtkparams2affmat.html">cmtkparams2affmat</a></span>(<span class="dt">rx=</span><span class="dv">180</span>)
<span class="co"># remove tiny values due to rounding errors</span>
rotm=<span class="kw">zapsmall</span>(rotm)
<span class="kw">plot</span>(<span class="kw"><a href="../reference/xform.html">xform</a></span>(Cell07PNs, rotm))</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-26-1.png" width="480"></p>
<p>More generally any function that works on a neuron can be applied to a neuronlist by using the function <code>nlapply</code>. This is an analogue to base R&rsquo;s <code>lapply</code> function. This will take care of returning a new neuronlist with the attached metadata and includes additional features such as error tolerance, progress bars and parallelisation for multi-core machines. It is worth reviewing the help and examples for this function carefully if you start to work regularly with neuronlists.</p>
</div>
</div>
<div id="plots" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#plots" class="anchor"> </a></body></html>Plots</h2>
<p>We have already seen that we can plot a single neuron (the first) like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(Cell07PNs[[<span class="dv">1</span>]])</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-27-1.png" width="768"></p>
<p>The purple node higlights the root or soma of the neuron, red nodes are branch points, green nodes are end points. We can also label each node with its <code>PointNo</code> index.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(Cell07PNs[[<span class="dv">1</span>]], <span class="dt">col=</span><span class="st">'red'</span>, <span class="dt">WithText=</span>T)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-28-1.png" width="768"></p>
<p>Multiple neurons can be plotted by passing a whole neuronlist or indexing it</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(Cell07PNs[<span class="dv">1</span>:<span class="dv">3</span>])</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-29-1.png" width="768"></p>
<p>More complex subsets are possible by using <code>plot.neuronlist</code> subset argument (which works in the same way as the <code>subset.neuronlist</code> function). For example here we select neurons by which olfactory glomeruli their dendrites occupy:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(Cell07PNs, <span class="dt">subset=</span>Glomerulus!=<span class="st">"DA1"</span>, <span class="dt">col=</span><span class="st">'grey'</span>, <span class="dt">WithNodes=</span>F, <span class="dt">main=</span><span class="st">"DA1 neurons"</span>)
<span class="kw">plot</span>(Cell07PNs, <span class="dt">subset=</span>Glomerulus==<span class="st">"DA1"</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-30-1.png" width="480"></p>
<div id="d-plots" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#d-plots" class="anchor"> </a></body></html>3D plots</h3>
<p>So far we have only used 2D plots in this document, but especially for interactive analysis and exploration, it is much more helpful to have 3D plots that can be rotated, zoomed etc. <strong>nat</strong> provides numerous functions for <a href="http://jefferis.github.io/nat/reference/index.html#section--d-plotting-of-objects">3D plots</a> based on the <a href="https://cran.r-project.org/package=rgl">rgl package</a>. It is actually possible to embed fully interactive 3d figures in <a href="http://rmarkdown.rstudio.com/">rmarkdown</a> reports like this one by setting the <a href="https://CRAN.R-project.org/package=rgl/vignettes/WebGL.html">webgl chunk option</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">clear3d</span>()
<span class="kw"><a href="../reference/plot3d.html">plot3d</a></span>(Cell07PNs[[<span class="dv">1</span>]], <span class="dt">col=</span><span class="st">'red'</span>)
<span class="co"># set a grey background so it's easier to see extent of the webgl canvas</span>
<span class="kw">bg3d</span>(<span class="dt">col=</span><span class="st">'lightgrey'</span>)</code></pre>
<script>/*
* Copyright (C) 2009 Apple Inc. All Rights Reserved.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions
* are met:
* 1. Redistributions of source code must retain the above copyright
*    notice, this list of conditions and the following disclaimer.
* 2. Redistributions in binary form must reproduce the above copyright
*    notice, this list of conditions and the following disclaimer in the
*    documentation and/or other materials provided with the distribution.
*
* THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
* EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
* PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
* CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
* EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
* PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
* PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
* OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
* OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
* Copyright (2016) Duncan Murdoch - fixed CanvasMatrix4.ortho,
* cleaned up.
*/
/*
CanvasMatrix4 class
This class implements a 4x4 matrix. It has functions which
duplicate the functionality of the OpenGL matrix stack and
glut functions.
IDL:
[
Constructor(in CanvasMatrix4 matrix),           // copy passed matrix into new CanvasMatrix4
Constructor(in sequence<float> array)           // create new CanvasMatrix4 with 16 floats (row major)
Constructor()                                   // create new CanvasMatrix4 with identity matrix
]
interface CanvasMatrix4 {
attribute float m11;
attribute float m12;
attribute float m13;
attribute float m14;
attribute float m21;
attribute float m22;
attribute float m23;
attribute float m24;
attribute float m31;
attribute float m32;
attribute float m33;
attribute float m34;
attribute float m41;
attribute float m42;
attribute float m43;
attribute float m44;
void load(in CanvasMatrix4 matrix);                 // copy the values from the passed matrix
void load(in sequence<float> array);                // copy 16 floats into the matrix
sequence<float> getAsArray();                       // return the matrix as an array of 16 floats
WebGLFloatArray getAsCanvasFloatArray();           // return the matrix as a WebGLFloatArray with 16 values
void makeIdentity();                                // replace the matrix with identity
void transpose();                                   // replace the matrix with its transpose
void invert();                                      // replace the matrix with its inverse
void translate(in float x, in float y, in float z); // multiply the matrix by passed translation values on the right
void scale(in float x, in float y, in float z);     // multiply the matrix by passed scale values on the right
void rotate(in float angle,                         // multiply the matrix by passed rotation values on the right
in float x, in float y, in float z);    // (angle is in degrees)
void multRight(in CanvasMatrix matrix);             // multiply the matrix by the passed matrix on the right
void multLeft(in CanvasMatrix matrix);              // multiply the matrix by the passed matrix on the left
void ortho(in float left, in float right,           // multiply the matrix by the passed ortho values on the right
in float bottom, in float top,
in float near, in float far);
void frustum(in float left, in float right,         // multiply the matrix by the passed frustum values on the right
in float bottom, in float top,
in float near, in float far);
void perspective(in float fovy, in float aspect,    // multiply the matrix by the passed perspective values on the right
in float zNear, in float zFar);
void lookat(in float eyex, in float eyey, in float eyez,    // multiply the matrix by the passed lookat
in float ctrx, in float ctry, in float ctrz,    // values on the right
in float upx, in float upy, in float upz);
}
*/
CanvasMatrix4 = function(m)
{
if (typeof m == 'object') {
if ("length" in m && m.length >= 16) {
this.load(m[0], m[1], m[2], m[3], m[4], m[5], m[6], m[7], m[8], m[9], m[10], m[11], m[12], m[13], m[14], m[15]);
return;
}
else if (m instanceof CanvasMatrix4) {
this.load(m);
return;
}
}
this.makeIdentity();
};
CanvasMatrix4.prototype.load = function()
{
if (arguments.length == 1 && typeof arguments[0] == 'object') {
var matrix = arguments[0];
if ("length" in matrix && matrix.length == 16) {
this.m11 = matrix[0];
this.m12 = matrix[1];
this.m13 = matrix[2];
this.m14 = matrix[3];
this.m21 = matrix[4];
this.m22 = matrix[5];
this.m23 = matrix[6];
this.m24 = matrix[7];
this.m31 = matrix[8];
this.m32 = matrix[9];
this.m33 = matrix[10];
this.m34 = matrix[11];
this.m41 = matrix[12];
this.m42 = matrix[13];
this.m43 = matrix[14];
this.m44 = matrix[15];
return;
}
if (arguments[0] instanceof CanvasMatrix4) {
this.m11 = matrix.m11;
this.m12 = matrix.m12;
this.m13 = matrix.m13;
this.m14 = matrix.m14;
this.m21 = matrix.m21;
this.m22 = matrix.m22;
this.m23 = matrix.m23;
this.m24 = matrix.m24;
this.m31 = matrix.m31;
this.m32 = matrix.m32;
this.m33 = matrix.m33;
this.m34 = matrix.m34;
this.m41 = matrix.m41;
this.m42 = matrix.m42;
this.m43 = matrix.m43;
this.m44 = matrix.m44;
return;
}
}
this.makeIdentity();
};
CanvasMatrix4.prototype.getAsArray = function()
{
return [
this.m11, this.m12, this.m13, this.m14,
this.m21, this.m22, this.m23, this.m24,
this.m31, this.m32, this.m33, this.m34,
this.m41, this.m42, this.m43, this.m44
];
};
CanvasMatrix4.prototype.getAsWebGLFloatArray = function()
{
return new WebGLFloatArray(this.getAsArray());
};
CanvasMatrix4.prototype.makeIdentity = function()
{
this.m11 = 1;
this.m12 = 0;
this.m13 = 0;
this.m14 = 0;
this.m21 = 0;
this.m22 = 1;
this.m23 = 0;
this.m24 = 0;
this.m31 = 0;
this.m32 = 0;
this.m33 = 1;
this.m34 = 0;
this.m41 = 0;
this.m42 = 0;
this.m43 = 0;
this.m44 = 1;
};
CanvasMatrix4.prototype.transpose = function()
{
var tmp = this.m12;
this.m12 = this.m21;
this.m21 = tmp;
tmp = this.m13;
this.m13 = this.m31;
this.m31 = tmp;
tmp = this.m14;
this.m14 = this.m41;
this.m41 = tmp;
tmp = this.m23;
this.m23 = this.m32;
this.m32 = tmp;
tmp = this.m24;
this.m24 = this.m42;
this.m42 = tmp;
tmp = this.m34;
this.m34 = this.m43;
this.m43 = tmp;
};
CanvasMatrix4.prototype.invert = function()
{
// Calculate the 4x4 determinant
// If the determinant is zero,
// then the inverse matrix is not unique.
var det = this._determinant4x4();
if (Math.abs(det) < 1e-8)
return null;
this._makeAdjoint();
// Scale the adjoint matrix to get the inverse
this.m11 /= det;
this.m12 /= det;
this.m13 /= det;
this.m14 /= det;
this.m21 /= det;
this.m22 /= det;
this.m23 /= det;
this.m24 /= det;
this.m31 /= det;
this.m32 /= det;
this.m33 /= det;
this.m34 /= det;
this.m41 /= det;
this.m42 /= det;
this.m43 /= det;
this.m44 /= det;
};
CanvasMatrix4.prototype.translate = function(x,y,z)
{
if (x === undefined)
x = 0;
if (y === undefined)
y = 0;
if (z === undefined)
z = 0;
var matrix = new CanvasMatrix4();
matrix.m41 = x;
matrix.m42 = y;
matrix.m43 = z;
this.multRight(matrix);
};
CanvasMatrix4.prototype.scale = function(x,y,z)
{
if (x === undefined)
x = 1;
if (z === undefined) {
if (y === undefined) {
y = x;
z = x;
}
else
z = 1;
}
else if (y === undefined)
y = x;
var matrix = new CanvasMatrix4();
matrix.m11 = x;
matrix.m22 = y;
matrix.m33 = z;
this.multRight(matrix);
};
CanvasMatrix4.prototype.rotate = function(angle,x,y,z)
{
// angles are in degrees. Switch to radians
angle = angle / 180 * Math.PI;
angle /= 2;
var sinA = Math.sin(angle);
var cosA = Math.cos(angle);
var sinA2 = sinA * sinA;
// normalize
var length = Math.sqrt(x * x + y * y + z * z);
if (length === 0) {
// bad vector, just use something reasonable
x = 0;
y = 0;
z = 1;
} else if (length != 1) {
x /= length;
y /= length;
z /= length;
}
var mat = new CanvasMatrix4();
// optimize case where axis is along major axis
if (x == 1 && y === 0 && z === 0) {
mat.m11 = 1;
mat.m12 = 0;
mat.m13 = 0;
mat.m21 = 0;
mat.m22 = 1 - 2 * sinA2;
mat.m23 = 2 * sinA * cosA;
mat.m31 = 0;
mat.m32 = -2 * sinA * cosA;
mat.m33 = 1 - 2 * sinA2;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
} else if (x === 0 && y == 1 && z === 0) {
mat.m11 = 1 - 2 * sinA2;
mat.m12 = 0;
mat.m13 = -2 * sinA * cosA;
mat.m21 = 0;
mat.m22 = 1;
mat.m23 = 0;
mat.m31 = 2 * sinA * cosA;
mat.m32 = 0;
mat.m33 = 1 - 2 * sinA2;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
} else if (x === 0 && y === 0 && z == 1) {
mat.m11 = 1 - 2 * sinA2;
mat.m12 = 2 * sinA * cosA;
mat.m13 = 0;
mat.m21 = -2 * sinA * cosA;
mat.m22 = 1 - 2 * sinA2;
mat.m23 = 0;
mat.m31 = 0;
mat.m32 = 0;
mat.m33 = 1;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
} else {
var x2 = x*x;
var y2 = y*y;
var z2 = z*z;
mat.m11 = 1 - 2 * (y2 + z2) * sinA2;
mat.m12 = 2 * (x * y * sinA2 + z * sinA * cosA);
mat.m13 = 2 * (x * z * sinA2 - y * sinA * cosA);
mat.m21 = 2 * (y * x * sinA2 - z * sinA * cosA);
mat.m22 = 1 - 2 * (z2 + x2) * sinA2;
mat.m23 = 2 * (y * z * sinA2 + x * sinA * cosA);
mat.m31 = 2 * (z * x * sinA2 + y * sinA * cosA);
mat.m32 = 2 * (z * y * sinA2 - x * sinA * cosA);
mat.m33 = 1 - 2 * (x2 + y2) * sinA2;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
}
this.multRight(mat);
};
CanvasMatrix4.prototype.multRight = function(mat)
{
var m11 = (this.m11 * mat.m11 + this.m12 * mat.m21 +
this.m13 * mat.m31 + this.m14 * mat.m41);
var m12 = (this.m11 * mat.m12 + this.m12 * mat.m22 +
this.m13 * mat.m32 + this.m14 * mat.m42);
var m13 = (this.m11 * mat.m13 + this.m12 * mat.m23 +
this.m13 * mat.m33 + this.m14 * mat.m43);
var m14 = (this.m11 * mat.m14 + this.m12 * mat.m24 +
this.m13 * mat.m34 + this.m14 * mat.m44);
var m21 = (this.m21 * mat.m11 + this.m22 * mat.m21 +
this.m23 * mat.m31 + this.m24 * mat.m41);
var m22 = (this.m21 * mat.m12 + this.m22 * mat.m22 +
this.m23 * mat.m32 + this.m24 * mat.m42);
var m23 = (this.m21 * mat.m13 + this.m22 * mat.m23 +
this.m23 * mat.m33 + this.m24 * mat.m43);
var m24 = (this.m21 * mat.m14 + this.m22 * mat.m24 +
this.m23 * mat.m34 + this.m24 * mat.m44);
var m31 = (this.m31 * mat.m11 + this.m32 * mat.m21 +
this.m33 * mat.m31 + this.m34 * mat.m41);
var m32 = (this.m31 * mat.m12 + this.m32 * mat.m22 +
this.m33 * mat.m32 + this.m34 * mat.m42);
var m33 = (this.m31 * mat.m13 + this.m32 * mat.m23 +
this.m33 * mat.m33 + this.m34 * mat.m43);
var m34 = (this.m31 * mat.m14 + this.m32 * mat.m24 +
this.m33 * mat.m34 + this.m34 * mat.m44);
var m41 = (this.m41 * mat.m11 + this.m42 * mat.m21 +
this.m43 * mat.m31 + this.m44 * mat.m41);
var m42 = (this.m41 * mat.m12 + this.m42 * mat.m22 +
this.m43 * mat.m32 + this.m44 * mat.m42);
var m43 = (this.m41 * mat.m13 + this.m42 * mat.m23 +
this.m43 * mat.m33 + this.m44 * mat.m43);
var m44 = (this.m41 * mat.m14 + this.m42 * mat.m24 +
this.m43 * mat.m34 + this.m44 * mat.m44);
this.m11 = m11;
this.m12 = m12;
this.m13 = m13;
this.m14 = m14;
this.m21 = m21;
this.m22 = m22;
this.m23 = m23;
this.m24 = m24;
this.m31 = m31;
this.m32 = m32;
this.m33 = m33;
this.m34 = m34;
this.m41 = m41;
this.m42 = m42;
this.m43 = m43;
this.m44 = m44;
};
CanvasMatrix4.prototype.multLeft = function(mat)
{
var m11 = (mat.m11 * this.m11 + mat.m12 * this.m21 +
mat.m13 * this.m31 + mat.m14 * this.m41);
var m12 = (mat.m11 * this.m12 + mat.m12 * this.m22 +
mat.m13 * this.m32 + mat.m14 * this.m42);
var m13 = (mat.m11 * this.m13 + mat.m12 * this.m23 +
mat.m13 * this.m33 + mat.m14 * this.m43);
var m14 = (mat.m11 * this.m14 + mat.m12 * this.m24 +
mat.m13 * this.m34 + mat.m14 * this.m44);
var m21 = (mat.m21 * this.m11 + mat.m22 * this.m21 +
mat.m23 * this.m31 + mat.m24 * this.m41);
var m22 = (mat.m21 * this.m12 + mat.m22 * this.m22 +
mat.m23 * this.m32 + mat.m24 * this.m42);
var m23 = (mat.m21 * this.m13 + mat.m22 * this.m23 +
mat.m23 * this.m33 + mat.m24 * this.m43);
var m24 = (mat.m21 * this.m14 + mat.m22 * this.m24 +
mat.m23 * this.m34 + mat.m24 * this.m44);
var m31 = (mat.m31 * this.m11 + mat.m32 * this.m21 +
mat.m33 * this.m31 + mat.m34 * this.m41);
var m32 = (mat.m31 * this.m12 + mat.m32 * this.m22 +
mat.m33 * this.m32 + mat.m34 * this.m42);
var m33 = (mat.m31 * this.m13 + mat.m32 * this.m23 +
mat.m33 * this.m33 + mat.m34 * this.m43);
var m34 = (mat.m31 * this.m14 + mat.m32 * this.m24 +
mat.m33 * this.m34 + mat.m34 * this.m44);
var m41 = (mat.m41 * this.m11 + mat.m42 * this.m21 +
mat.m43 * this.m31 + mat.m44 * this.m41);
var m42 = (mat.m41 * this.m12 + mat.m42 * this.m22 +
mat.m43 * this.m32 + mat.m44 * this.m42);
var m43 = (mat.m41 * this.m13 + mat.m42 * this.m23 +
mat.m43 * this.m33 + mat.m44 * this.m43);
var m44 = (mat.m41 * this.m14 + mat.m42 * this.m24 +
mat.m43 * this.m34 + mat.m44 * this.m44);
this.m11 = m11;
this.m12 = m12;
this.m13 = m13;
this.m14 = m14;
this.m21 = m21;
this.m22 = m22;
this.m23 = m23;
this.m24 = m24;
this.m31 = m31;
this.m32 = m32;
this.m33 = m33;
this.m34 = m34;
this.m41 = m41;
this.m42 = m42;
this.m43 = m43;
this.m44 = m44;
};
CanvasMatrix4.prototype.ortho = function(left, right, bottom, top, near, far)
{
var tx = (left + right) / (left - right);
var ty = (top + bottom) / (bottom - top);
var tz = (far + near) / (near - far);
var matrix = new CanvasMatrix4();
matrix.m11 = 2 / (right - left);
matrix.m12 = 0;
matrix.m13 = 0;
matrix.m14 = 0;
matrix.m21 = 0;
matrix.m22 = 2 / (top - bottom);
matrix.m23 = 0;
matrix.m24 = 0;
matrix.m31 = 0;
matrix.m32 = 0;
matrix.m33 = -2 / (far - near);
matrix.m34 = 0;
matrix.m41 = tx;
matrix.m42 = ty;
matrix.m43 = tz;
matrix.m44 = 1;
this.multRight(matrix);
};
CanvasMatrix4.prototype.frustum = function(left, right, bottom, top, near, far)
{
var matrix = new CanvasMatrix4();
var A = (right + left) / (right - left);
var B = (top + bottom) / (top - bottom);
var C = -(far + near) / (far - near);
var D = -(2 * far * near) / (far - near);
matrix.m11 = (2 * near) / (right - left);
matrix.m12 = 0;
matrix.m13 = 0;
matrix.m14 = 0;
matrix.m21 = 0;
matrix.m22 = 2 * near / (top - bottom);
matrix.m23 = 0;
matrix.m24 = 0;
matrix.m31 = A;
matrix.m32 = B;
matrix.m33 = C;
matrix.m34 = -1;
matrix.m41 = 0;
matrix.m42 = 0;
matrix.m43 = D;
matrix.m44 = 0;
this.multRight(matrix);
};
CanvasMatrix4.prototype.perspective = function(fovy, aspect, zNear, zFar)
{
var top = Math.tan(fovy * Math.PI / 360) * zNear;
var bottom = -top;
var left = aspect * bottom;
var right = aspect * top;
this.frustum(left, right, bottom, top, zNear, zFar);
};
CanvasMatrix4.prototype.lookat = function(eyex, eyey, eyez, centerx, centery, centerz, upx, upy, upz)
{
var matrix = new CanvasMatrix4();
// Make rotation matrix
// Z vector
var zx = eyex - centerx;
var zy = eyey - centery;
var zz = eyez - centerz;
var mag = Math.sqrt(zx * zx + zy * zy + zz * zz);
if (mag) {
zx /= mag;
zy /= mag;
zz /= mag;
}
// Y vector
var yx = upx;
var yy = upy;
var yz = upz;
// X vector = Y cross Z
xx =  yy * zz - yz * zy;
xy = -yx * zz + yz * zx;
xz =  yx * zy - yy * zx;
// Recompute Y = Z cross X
yx = zy * xz - zz * xy;
yy = -zx * xz + zz * xx;
yx = zx * xy - zy * xx;
// cross product gives area of parallelogram, which is < 1.0 for
// non-perpendicular unit-length vectors; so normalize x, y here
mag = Math.sqrt(xx * xx + xy * xy + xz * xz);
if (mag) {
xx /= mag;
xy /= mag;
xz /= mag;
}
mag = Math.sqrt(yx * yx + yy * yy + yz * yz);
if (mag) {
yx /= mag;
yy /= mag;
yz /= mag;
}
matrix.m11 = xx;
matrix.m12 = xy;
matrix.m13 = xz;
matrix.m14 = 0;
matrix.m21 = yx;
matrix.m22 = yy;
matrix.m23 = yz;
matrix.m24 = 0;
matrix.m31 = zx;
matrix.m32 = zy;
matrix.m33 = zz;
matrix.m34 = 0;
matrix.m41 = 0;
matrix.m42 = 0;
matrix.m43 = 0;
matrix.m44 = 1;
matrix.translate(-eyex, -eyey, -eyez);
this.multRight(matrix);
};
// Support functions
CanvasMatrix4.prototype._determinant2x2 = function(a, b, c, d)
{
return a * d - b * c;
};
CanvasMatrix4.prototype._determinant3x3 = function(a1, a2, a3, b1, b2, b3, c1, c2, c3)
{
return a1 * this._determinant2x2(b2, b3, c2, c3) -
b1 * this._determinant2x2(a2, a3, c2, c3) +
c1 * this._determinant2x2(a2, a3, b2, b3);
};
CanvasMatrix4.prototype._determinant4x4 = function()
{
var a1 = this.m11;
var b1 = this.m12;
var c1 = this.m13;
var d1 = this.m14;
var a2 = this.m21;
var b2 = this.m22;
var c2 = this.m23;
var d2 = this.m24;
var a3 = this.m31;
var b3 = this.m32;
var c3 = this.m33;
var d3 = this.m34;
var a4 = this.m41;
var b4 = this.m42;
var c4 = this.m43;
var d4 = this.m44;
return a1 * this._determinant3x3(b2, b3, b4, c2, c3, c4, d2, d3, d4) -
b1 * this._determinant3x3(a2, a3, a4, c2, c3, c4, d2, d3, d4) +
c1 * this._determinant3x3(a2, a3, a4, b2, b3, b4, d2, d3, d4) -
d1 * this._determinant3x3(a2, a3, a4, b2, b3, b4, c2, c3, c4);
};
CanvasMatrix4.prototype._makeAdjoint = function()
{
var a1 = this.m11;
var b1 = this.m12;
var c1 = this.m13;
var d1 = this.m14;
var a2 = this.m21;
var b2 = this.m22;
var c2 = this.m23;
var d2 = this.m24;
var a3 = this.m31;
var b3 = this.m32;
var c3 = this.m33;
var d3 = this.m34;
var a4 = this.m41;
var b4 = this.m42;
var c4 = this.m43;
var d4 = this.m44;
// Row column labeling reversed since we transpose rows & columns
this.m11  =   this._determinant3x3(b2, b3, b4, c2, c3, c4, d2, d3, d4);
this.m21  = - this._determinant3x3(a2, a3, a4, c2, c3, c4, d2, d3, d4);
this.m31  =   this._determinant3x3(a2, a3, a4, b2, b3, b4, d2, d3, d4);
this.m41  = - this._determinant3x3(a2, a3, a4, b2, b3, b4, c2, c3, c4);
this.m12  = - this._determinant3x3(b1, b3, b4, c1, c3, c4, d1, d3, d4);
this.m22  =   this._determinant3x3(a1, a3, a4, c1, c3, c4, d1, d3, d4);
this.m32  = - this._determinant3x3(a1, a3, a4, b1, b3, b4, d1, d3, d4);
this.m42  =   this._determinant3x3(a1, a3, a4, b1, b3, b4, c1, c3, c4);
this.m13  =   this._determinant3x3(b1, b2, b4, c1, c2, c4, d1, d2, d4);
this.m23  = - this._determinant3x3(a1, a2, a4, c1, c2, c4, d1, d2, d4);
this.m33  =   this._determinant3x3(a1, a2, a4, b1, b2, b4, d1, d2, d4);
this.m43  = - this._determinant3x3(a1, a2, a4, b1, b2, b4, c1, c2, c4);
this.m14  = - this._determinant3x3(b1, b2, b3, c1, c2, c3, d1, d2, d3);
this.m24  =   this._determinant3x3(a1, a2, a3, c1, c2, c3, d1, d2, d3);
this.m34  = - this._determinant3x3(a1, a2, a3, b1, b2, b3, d1, d2, d3);
this.m44  =   this._determinant3x3(a1, a2, a3, b1, b2, b3, c1, c2, c3);
};</script><script>
rglwidgetClass = function() {
this.canvas = null;
this.userMatrix = new CanvasMatrix4();
this.types = [];
this.prMatrix = new CanvasMatrix4();
this.mvMatrix = new CanvasMatrix4();
this.vp = null;
this.prmvMatrix = null;
this.origs = null;
this.gl = null;
this.scene = null;
};
(function() {
this.multMV = function(M, v) {
return [ M.m11 * v[0] + M.m12 * v[1] + M.m13 * v[2] + M.m14 * v[3],
M.m21 * v[0] + M.m22 * v[1] + M.m23 * v[2] + M.m24 * v[3],
M.m31 * v[0] + M.m32 * v[1] + M.m33 * v[2] + M.m34 * v[3],
M.m41 * v[0] + M.m42 * v[1] + M.m43 * v[2] + M.m44 * v[3]
];
};
this.vlen = function(v) {
return Math.sqrt(this.dotprod(v, v));
};
this.dotprod = function(a, b) {
return a[0]*b[0] + a[1]*b[1] + a[2]*b[2];
};
this.xprod = function(a, b) {
return [a[1]*b[2] - a[2]*b[1],
a[2]*b[0] - a[0]*b[2],
a[0]*b[1] - a[1]*b[0]];
};
this.cbind = function(a, b) {
return a.map(function(currentValue, index, array) {
return currentValue.concat(b[index]);
});
};
this.swap = function(a, i, j) {
var temp = a[i];
a[i] = a[j];
a[j] = temp;
};
this.flatten = function(a) {
return [].concat.apply([], a);
};
/* set element of 1d or 2d array as if it was flattened.  Column major, zero based! */
this.setElement = function(a, i, value) {
if (Array.isArray(a[0])) {
var dim = a.length,
col = Math.floor(i/dim),
row = i % dim;
a[row][col] = value;
} else {
a[i] = value;
}
};
this.transpose = function(a) {
var newArray = [],
n = a.length,
m = a[0].length,
i;
for(i = 0; i < m; i++){
newArray.push([]);
}
for(i = 0; i < n; i++){
for(var j = 0; j < m; j++){
newArray[j].push(a[i][j]);
}
}
return newArray;
};
this.sumsq = function(x) {
var result = 0, i;
for (i=0; i < x.length; i++)
result += x[i]*x[i];
return result;
};
this.toCanvasMatrix4 = function(mat) {
if (mat instanceof CanvasMatrix4)
return mat;
var result = new CanvasMatrix4();
mat = this.flatten(this.transpose(mat));
result.load(mat);
return result;
};
this.stringToRgb = function(s) {
s = s.replace("#", "");
var bigint = parseInt(s, 16);
return [((bigint >> 16) & 255)/255,
((bigint >> 8) & 255)/255,
(bigint & 255)/255];
};
this.componentProduct = function(x, y) {
if (typeof y === "undefined") {
this.alertOnce("Bad arg to componentProduct");
}
var result = new Float32Array(3), i;
for (i = 0; i<3; i++)
result[i] = x[i]*y[i];
return result;
};
this.getPowerOfTwo = function(value) {
var pow = 1;
while(pow<value) {
pow *= 2;
}
return pow;
};
this.unique = function(arr) {
arr = [].concat(arr);
return arr.filter(function(value, index, self) {
return self.indexOf(value) === index;
});
};
this.repeatToLen = function(arr, len) {
arr = [].concat(arr);
while (arr.length < len/2)
arr = arr.concat(arr);
return arr.concat(arr.slice(0, len - arr.length));
};
this.alertOnce = function(msg) {
if (typeof this.alerted !== "undefined")
return;
this.alerted = true;
alert(msg);
};
this.f_is_lit = 1;
this.f_is_smooth = 2;
this.f_has_texture = 4;
this.f_is_indexed = 8;
this.f_depth_sort = 16;
this.f_fixed_quads = 32;
this.f_is_transparent = 64;
this.f_is_lines = 128;
this.f_sprites_3d = 256;
this.f_sprite_3d = 512;
this.f_is_subscene = 1024;
this.f_is_clipplanes = 2048;
this.whichList = function(id) {
var obj = this.getObj(id),
flags = obj.flags;
if (obj.type === "light")
return "lights";
if (flags & this.f_is_subscene)
return "subscenes";
if (flags & this.f_is_clipplanes)
return "clipplanes";
if (flags & this.f_is_transparent)
return "transparent";
return "opaque";
};
this.getObj = function(id) {
if (typeof id !== "number") {
this.alertOnce("getObj id is "+typeof id);
}
return this.scene.objects[id];
};
this.getIdsByType = function(type, subscene) {
var
result = [], i, self = this;
if (typeof subscene === "undefined") {
Object.keys(this.scene.objects).forEach(
function(key) {
key = parseInt(key, 10);
if (self.getObj(key).type === type)
result.push(key);
});
} else {
ids = this.getObj(subscene).objects;
for (i=0; i < ids.length; i++) {
if (this.getObj(ids[i]).type === type) {
result.push(ids[i]);
}
}
}
return result;
};
this.getMaterial = function(id, property) {
var obj = this.getObj(id),
mat = obj.material[property];
if (typeof mat === "undefined")
mat = this.scene.material[property];
return mat;
};
this.inSubscene = function(id, subscene) {
return this.getObj(subscene).objects.indexOf(id) > -1;
};
this.addToSubscene = function(id, subscene) {
var thelist,
thesub = this.getObj(subscene),
ids = [id],
obj = this.getObj(id), i;
if (typeof obj.newIds !== "undefined") {
ids = ids.concat(obj.newIds);
}
for (i = 0; i < ids.length; i++) {
id = ids[i];
if (thesub.objects.indexOf(id) == -1) {
thelist = this.whichList(id);
thesub.objects.push(id);
thesub[thelist].push(id);
}
}
};
this.delFromSubscene = function(id, subscene) {
var thelist,
thesub = this.getObj(subscene),
obj = this.getObj(id),
ids = [id], i;
if (typeof obj.newIds !== "undefined")
ids = ids.concat(obj.newIds);
for (j=0; j<ids.length;j++) {
id = ids[j];
i = thesub.objects.indexOf(id);
if (i > -1) {
thesub.objects.splice(i, 1);
thelist = this.whichList(id);
i = thesub[thelist].indexOf(id);
thesub[thelist].splice(i, 1);
}
}
};
this.setSubsceneEntries = function(ids, subsceneid) {
var sub = this.getObj(subsceneid);
sub.objects = ids;
this.initSubscene(subsceneid);
};
this.getSubsceneEntries = function(subscene) {
return this.getObj(subscene).objects;
};
this.getChildSubscenes = function(subscene) {
return this.getObj(subscene).subscenes;
};
this.startDrawing = function() {
var value = this.drawing;
this.drawing = true;
return value;
}
this.stopDrawing = function(saved) {
this.drawing = saved;
if (!saved && this.gl && this.gl.isContextLost())
this.restartCanvas();
}
this.getVertexShader = function(id) {
var obj = this.getObj(id),
flags = obj.flags,
type = obj.type,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
sprites_3d = flags & this.f_sprites_3d,
sprite_3d = flags & this.f_sprite_3d,
nclipplanes = this.countClipplanes(),
result;
if (type === "clipplanes" || sprites_3d) return;
result = "  /* ****** "+type+" object "+id+" vertex shader ****** */\n"+
"  attribute vec3 aPos;\n"+
"  attribute vec4 aCol;\n"+
" uniform mat4 mvMatrix;\n"+
" uniform mat4 prMatrix;\n"+
" varying vec4 vCol;\n"+
" varying vec4 vPosition;\n";
if ((is_lit && !fixed_quads) || sprite_3d)
result = result + "  attribute vec3 aNorm;\n"+
" uniform mat4 normMatrix;\n"+
" varying vec3 vNormal;\n";
if (has_texture || type === "text")
result = result + " attribute vec2 aTexcoord;\n"+
" varying vec2 vTexcoord;\n";
if (type === "text")
result = result + "  uniform vec2 textScale;\n";
if (fixed_quads)
result = result + "  attribute vec2 aOfs;\n";
else if (sprite_3d)
result = result + "  uniform vec3 uOrig;\n"+
" uniform float uSize;\n"+
" uniform mat4 usermat;\n";
result = result + "  void main(void) {\n";
if (nclipplanes || (!fixed_quads && !sprite_3d))
result = result + "    vPosition = mvMatrix * vec4(aPos, 1.);\n";
if (!fixed_quads && !sprite_3d)
result = result + "    gl_Position = prMatrix * vPosition;\n";
if (type == "points") {
var size = this.getMaterial(id, "size");
result = result + "    gl_PointSize = "+size.toFixed(1)+";\n";
}
result = result + "    vCol = aCol;\n";
if (is_lit && !fixed_quads && !sprite_3d)
result = result + "    vNormal = normalize((normMatrix * vec4(aNorm, 1.)).xyz);\n";
if (has_texture || type === "text")
result = result + "    vTexcoord = aTexcoord;\n";
if (type == "text")
result = result + "    vec4 pos = prMatrix * mvMatrix * vec4(aPos, 1.);\n"+
"   pos = pos/pos.w;\n"+
"   gl_Position = pos + vec4(aOfs*textScale, 0.,0.);\n";
if (type == "sprites")
result = result + "    vec4 pos = mvMatrix * vec4(aPos, 1.);\n"+
"   pos = pos/pos.w + vec4(aOfs, 0., 0.);\n"+
"   gl_Position = prMatrix*pos;\n";
if (sprite_3d)
result = result + "    vNormal = normalize((normMatrix * vec4(aNorm, 1.)).xyz);\n"+
"   vec4 pos = mvMatrix * vec4(uOrig, 1.);\n"+
"   vPosition = pos/pos.w + vec4(uSize*(vec4(aPos, 1.)*usermat).xyz,0.);\n"+
"   gl_Position = prMatrix * vPosition;\n";
result = result + "  }\n";
return result;
};
this.getFragmentShader = function(id) {
var obj = this.getObj(id),
flags = obj.flags,
type = obj.type,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
sprites_3d = flags & this.f_sprites_3d,
nclipplanes = this.countClipplanes(), i,
texture_format, nlights,
result;
if (type === "clipplanes" || sprites_3d) return;
if (has_texture)
texture_format = this.getMaterial(id, "textype");
result = "/* ****** "+type+" object "+id+" fragment shader ****** */\n"+
"#ifdef GL_ES\n"+
"  precision highp float;\n"+
"#endif\n"+
"  varying vec4 vCol; // carries alpha\n"+
"  varying vec4 vPosition;\n";
if (has_texture || type === "text")
result = result + "  varying vec2 vTexcoord;\n"+
" uniform sampler2D uSampler;\n";
if (is_lit && !fixed_quads)
result = result + "  varying vec3 vNormal;\n";
for (i = 0; i < nclipplanes; i++)
result = result + "  uniform vec4 vClipplane"+i+";\n";
if (is_lit) {
nlights = this.countLights();
if (nlights)
result = result + "  uniform mat4 mvMatrix;\n";
else
is_lit = false;
}
if (is_lit) {
result = result + "    uniform vec3 emission;\n"+
"   uniform float shininess;\n";
for (i=0; i < nlights; i++) {
result = result + "    uniform vec3 ambient" + i + ";\n"+
"   uniform vec3 specular" + i +"; // light*material\n"+
"   uniform vec3 diffuse" + i + ";\n"+
"   uniform vec3 lightDir" + i + ";\n"+
"   uniform bool viewpoint" + i + ";\n"+
"   uniform bool finite" + i + ";\n";
}
}
result = result + "  void main(void) {\n";
for (i=0; i < nclipplanes;i++)
result = result + "    if (dot(vPosition, vClipplane"+i+") < 0.0) discard;\n";
if (is_lit) {
result = result + "    vec3 eye = normalize(-vPosition.xyz);\n"+
"   vec3 lightdir;\n"+
"   vec4 colDiff;\n"+
"   vec3 halfVec;\n"+
"   vec4 lighteffect = vec4(emission, 0.);\n"+
"   vec3 col;\n"+
"   float nDotL;\n";
if (fixed_quads) {
result = result +   "    vec3 n = vec3(0., 0., 1.);\n";
}
else {
result = result +   "    vec3 n = normalize(vNormal);\n"+
"   n = -faceforward(n, n, eye);\n";
}
for (i=0; i < nlights; i++) {
result = result + "   colDiff = vec4(vCol.rgb * diffuse" + i + ", vCol.a);\n"+
"   lightdir = lightDir" + i + ";\n"+
"   if (!viewpoint" + i +")\n"+
"     lightdir = (mvMatrix * vec4(lightdir, 1.)).xyz;\n"+
"   if (!finite" + i + ") {\n"+
"     halfVec = normalize(lightdir + eye);\n"+
"   } else {\n"+
"     lightdir = normalize(lightdir - vPosition.xyz);\n"+
"     halfVec = normalize(lightdir + eye);\n"+
"   }\n"+
"    col = ambient" + i + ";\n"+
"   nDotL = dot(n, lightdir);\n"+
"   col = col + max(nDotL, 0.) * colDiff.rgb;\n"+
"   col = col + pow(max(dot(halfVec, n), 0.), shininess) * specular" + i + ";\n"+
"   lighteffect = lighteffect + vec4(col, colDiff.a);\n";
}
} else {
result = result +   "   vec4 colDiff = vCol;\n"+
"    vec4 lighteffect = colDiff;\n";
}
if ((has_texture && texture_format === "rgba") || type === "text")
result = result +   "    vec4 textureColor = lighteffect*texture2D(uSampler, vTexcoord);\n";
if (has_texture) {
result = result + {
rgb:            "   vec4 textureColor = lighteffect*vec4(texture2D(uSampler, vTexcoord).rgb, 1.);\n",
alpha:          "   vec4 textureColor = texture2D(uSampler, vTexcoord);\n"+
"   float luminance = dot(vec3(1.,1.,1.), textureColor.rgb)/3.;\n"+
"   textureColor =  vec4(lighteffect.rgb, lighteffect.a*luminance);\n",
luminance:      "   vec4 textureColor = vec4(lighteffect.rgb*dot(texture2D(uSampler, vTexcoord).rgb, vec3(1.,1.,1.))/3., lighteffect.a);\n",
"luminance.alpha":"    vec4 textureColor = texture2D(uSampler, vTexcoord);\n"+
"   float luminance = dot(vec3(1.,1.,1.),textureColor.rgb)/3.;\n"+
"   textureColor = vec4(lighteffect.rgb*luminance, lighteffect.a*textureColor.a);\n"
}[texture_format]+
"   gl_FragColor = textureColor;\n";
} else if (type === "text") {
result = result +   "    if (textureColor.a < 0.1)\n"+
"     discard;\n"+
"   else\n"+
"     gl_FragColor = textureColor;\n";
} else
result = result +   "   gl_FragColor = lighteffect;\n";
result = result + "  }\n";
return result;
};
this.getShader = function(shaderType, code) {
var gl = this.gl, shader;
shader = gl.createShader(shaderType);
gl.shaderSource(shader, code);
gl.compileShader(shader);
if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS) && !gl.isContextLost())
alert(gl.getShaderInfoLog(shader));
return shader;
};
this.handleLoadedTexture = function(texture, textureCanvas) { 
var gl = this.gl || this.initGL();
gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
gl.bindTexture(gl.TEXTURE_2D, texture);
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textureCanvas);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
gl.generateMipmap(gl.TEXTURE_2D);
gl.bindTexture(gl.TEXTURE_2D, null);
};
this.loadImageToTexture = function(uri, texture) {
var canvas = this.textureCanvas,
ctx = canvas.getContext("2d"),
image = new Image(),
self = this;
image.onload = function() {
var w = image.width,
h = image.height,
canvasX = self.getPowerOfTwo(w),
canvasY = self.getPowerOfTwo(h),
gl = self.gl || self.initGL(),
maxTexSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
if (maxTexSize > 4096) maxTexSize = 4096;
while (canvasX > 1 && canvasY > 1 && (canvasX > maxTexSize || canvasY > maxTexSize)) {
canvasX /= 2;
canvasY /= 2;
}
canvas.width = canvasX;
canvas.height = canvasY;
ctx.imageSmoothingEnabled = true;
ctx.drawImage(image, 0, 0, canvasX, canvasY);
self.handleLoadedTexture(texture, canvas);
self.drawScene();
};
image.src = uri;
};
this.drawTextToCanvas = function(text, cex, family, font) {
var canvasX, canvasY,
textY,
scaling = 20,
textColour = "white",
backgroundColour = "rgba(0,0,0,0)",
canvas = this.textureCanvas,
ctx = canvas.getContext("2d"),
i, textHeights = [], widths = [], offset = 0, offsets = [],
fontStrings = [],
getFontString = function(i) {
textHeights[i] = scaling*cex[i];
var fontString = textHeights[i] + "px",
family0 = family[i],
font0 = font[i];
if (family0 === "sans")
family0 = "sans-serif";
else if (family0 === "mono")
family0 = "monospace";
fontString = fontString + " " + family0;
if (font0 === 2 || font0 === 4)
fontString = "bold " + fontString;
if (font0 === 3 || font0 === 4)
fontString = "italic " + fontString;
return fontString;
};
cex = this.repeatToLen(cex, text.length);
family = this.repeatToLen(family, text.length);
font = this.repeatToLen(font, text.length);
canvasX = 1;
for (i = 0; i < text.length; i++)  {
ctx.font = fontStrings[i] = getFontString(i);
widths[i] = ctx.measureText(text[i]).width;
offset = offsets[i] = offset + 2*textHeights[i];
canvasX = (widths[i] > canvasX) ? widths[i] : canvasX;
}
canvasX = this.getPowerOfTwo(canvasX);
canvasY = this.getPowerOfTwo(offset);
canvas.width = canvasX;
canvas.height = canvasY;
ctx.fillStyle = backgroundColour;
ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
ctx.textBaseline = "alphabetic";
for(i = 0; i < text.length; i++) {
textY = offsets[i];
ctx.font = fontStrings[i];
ctx.fillStyle = textColour;
ctx.textAlign = "left";
ctx.fillText(text[i], 0,  textY);
}
return {canvasX:canvasX, canvasY:canvasY,
widths:widths, textHeights:textHeights,
offsets:offsets};
};
this.setViewport = function(id) {
var gl = this.gl || this.initGL(),
vp = this.getObj(id).par3d.viewport,
x = vp.x*this.canvas.width,
y = vp.y*this.canvas.height,
width = vp.width*this.canvas.width,
height = vp.height*this.canvas.height;
this.vp = {x:x, y:y, width:width, height:height};
gl.viewport(x, y, width, height);
gl.scissor(x, y, width, height);
gl.enable(gl.SCISSOR_TEST);
};
this.setprMatrix = function(id) {
var subscene = this.getObj(id),
embedding = subscene.embeddings.projection;
if (embedding === "replace")
this.prMatrix.makeIdentity();
else
this.setprMatrix(subscene.parent);
if (embedding === "inherit")
return;
// This is based on the Frustum::enclose code from geom.cpp
var bbox = subscene.par3d.bbox,
scale = subscene.par3d.scale,
ranges = [(bbox[1]-bbox[0])*scale[0]/2,
(bbox[3]-bbox[2])*scale[1]/2,
(bbox[5]-bbox[4])*scale[2]/2],
radius = Math.sqrt(this.sumsq(ranges))*1.1; // A bit bigger to handle labels
if (radius <= 0) radius = 1;
var observer = subscene.par3d.observer,
distance = observer[2],
FOV = subscene.par3d.FOV, ortho = FOV === 0,
t = ortho ? 1 : Math.tan(FOV*Math.PI/360),
near = distance - radius,
far = distance + radius,
hlen = t*near,
aspect = this.vp.width/this.vp.height,
z = subscene.par3d.zoom;
if (ortho) {
if (aspect > 1)
this.prMatrix.ortho(-hlen*aspect*z, hlen*aspect*z,
-hlen*z, hlen*z, near, far);
else
this.prMatrix.ortho(-hlen*z, hlen*z,
-hlen*z/aspect, hlen*z/aspect,
near, far);
} else {
if (aspect > 1)
this.prMatrix.frustum(-hlen*aspect*z, hlen*aspect*z,
-hlen*z, hlen*z, near, far);
else
this.prMatrix.frustum(-hlen*z, hlen*z,
-hlen*z/aspect, hlen*z/aspect,
near, far);
}
};
this.setmvMatrix = function(id) {
var observer = this.getObj(id).par3d.observer;
this.mvMatrix.makeIdentity();
this.setmodelMatrix(id);
this.mvMatrix.translate(-observer[0], -observer[1], -observer[2]);
};
this.setmodelMatrix = function(id) {
var subscene = this.getObj(id),
embedding = subscene.embeddings.model;
if (embedding !== "inherit") {
var scale = subscene.par3d.scale,
bbox = subscene.par3d.bbox,
center = [(bbox[0]+bbox[1])/2,
(bbox[2]+bbox[3])/2,
(bbox[4]+bbox[5])/2];
this.mvMatrix.translate(-center[0], -center[1], -center[2]);
this.mvMatrix.scale(scale[0], scale[1], scale[2]);
this.mvMatrix.multRight( subscene.par3d.userMatrix );
}
if (embedding !== "replace")
this.setmodelMatrix(subscene.parent);
};
this.setnormMatrix = function(subsceneid) {
var self = this,
recurse = function(id) {
var sub = self.getObj(id),
embedding = sub.embeddings.model;
if (embedding !== "inherit") {
var scale = sub.par3d.scale;
self.normMatrix.scale(1/scale[0], 1/scale[1], 1/scale[2]);
self.normMatrix.multRight(sub.par3d.userMatrix);
}
if (embedding !== "replace")
recurse(sub.parent);
};
self.normMatrix.makeIdentity();
recurse(subsceneid);
};
this.setprmvMatrix = function() {
this.prmvMatrix = new CanvasMatrix4( this.mvMatrix );
this.prmvMatrix.multRight( this.prMatrix );
};
this.countClipplanes = function() {
return this.countObjs("clipplanes");
};
this.countLights = function() {
return this.countObjs("light");
};
this.countObjs = function(type) {
var self = this,
bound = 0;
Object.keys(this.scene.objects).forEach(
function(key) {
if (self.getObj(parseInt(key, 10)).type === type)
bound = bound + 1;
});
return bound;
};
this.initSubscene = function(id) {
var sub = this.getObj(id),
i, obj;
if (sub.type !== "subscene")
return;
sub.par3d.userMatrix = this.toCanvasMatrix4(sub.par3d.userMatrix);
sub.par3d.listeners = [].concat(sub.par3d.listeners);
sub.backgroundId = undefined;
sub.subscenes = [];
sub.clipplanes = [];
sub.transparent = [];
sub.opaque = [];
sub.lights = [];
for (i=0; i < sub.objects.length; i++) {
obj = this.getObj(sub.objects[i]);
if (typeof obj === "undefined") {
sub.objects.splice(i, 1);
i--;
} else if (obj.type === "background")
sub.backgroundId = obj.id;
else
sub[this.whichList(obj.id)].push(obj.id);
}
};
this.copyObj = function(id, reuse) {
var obj = this.getObj(id),
prev = document.getElementById(reuse);
if (prev !== null) {
prev = prev.rglinstance;
var
prevobj = prev.getObj(id),
fields = ["flags", "type",
"colors", "vertices", "centers",
"normals", "offsets",
"texts", "cex", "family", "font", "adj",
"material",
"radii",
"texcoords",
"userMatrix", "ids",
"dim",
"par3d", "userMatrix",
"viewpoint", "finite"],
i;
for (i = 0; i < fields.length; i++) {
if (typeof prevobj[fields[i]] !== "undefined")
obj[fields[i]] = prevobj[fields[i]];
}
} else
console.warn("copyObj failed");
};
this.planeUpdateTriangles = function(id, bbox) {
var perms = [[0,0,1], [1,2,2], [2,1,0]],
x, xrow, elem, A, d, nhits, i, j, k, u, v, w, intersect, which, v0, v2, vx, reverse,
face1 = [], face2 = [], normals = [],
obj = this.getObj(id),
nPlanes = obj.normals.length;
obj.bbox = bbox;
obj.vertices = [];
obj.initialized = false;
for (elem = 0; elem < nPlanes; elem++) {
//    Vertex Av = normal.getRecycled(elem);
x = [];
A = obj.normals[elem];
d = obj.offsets[elem][0];
nhits = 0;
for (i=0; i<3; i++)
for (j=0; j<2; j++)
for (k=0; k<2; k++) {
u = perms[0][i];
v = perms[1][i];
w = perms[2][i];
if (A[w] !== 0.0) {
intersect = -(d + A[u]*bbox[j+2*u] + A[v]*bbox[k+2*v])/A[w];
if (bbox[2*w] < intersect && intersect < bbox[1+2*w]) {
xrow = [];
xrow[u] = bbox[j+2*u];
xrow[v] = bbox[k+2*v];
xrow[w] = intersect;
x.push(xrow);
face1[nhits] = j + 2*u;
face2[nhits] = k + 2*v;
nhits++;
}
}
}
if (nhits > 3) {
/* Re-order the intersections so the triangles work */
for (i=0; i<nhits-2; i++) {
which = 0; /* initialize to suppress warning */
for (j=i+1; j<nhits; j++) {
if (face1[i] == face1[j] || face1[i] == face2[j] ||
face2[i] == face1[j] || face2[i] == face2[j] ) {
which = j;
break;
}
}
if (which > i+1) {
this.swap(x, i+1, which);
this.swap(face1, i+1, which);
this.swap(face2, i+1, which);
}
}
}
if (nhits >= 3) {
/* Put in order so that the normal points out the FRONT of the faces */
v0 = [x[0][0] - x[1][0] , x[0][1] - x[1][1], x[0][2] - x[1][2]];
v2 = [x[2][0] - x[1][0] , x[2][1] - x[1][1], x[2][2] - x[1][2]];
/* cross-product */
vx = this.xprod(v0, v2);
reverse = this.dotprod(vx, A) > 0;
for (i=0; i<nhits-2; i++) {
obj.vertices.push(x[0]);
normals.push(A);
for (j=1; j<3; j++) {
obj.vertices.push(x[i + (reverse ? 3-j : j)]);
normals.push(A);
}
}
}
}
obj.pnormals = normals;
};
this.initObj = function(id) {
var obj = this.getObj(id),
flags = obj.flags,
type = obj.type,
is_indexed = flags & this.f_is_indexed,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
depth_sort = flags & this.f_depth_sort,
sprites_3d = flags & this.f_sprites_3d,
sprite_3d = flags & this.f_sprite_3d,
gl = this.gl || this.initGL(),
texinfo, drawtype, nclipplanes, f, frowsize, nrows,
i,j,v, mat, uri, matobj;
if (typeof id !== "number") {
this.alertOnce("initObj id is "+typeof id);
}
obj.initialized = true;
if (type === "bboxdeco" || type === "subscene")
return;
if (type === "light") {
obj.ambient = new Float32Array(obj.colors[0].slice(0,3));
obj.diffuse = new Float32Array(obj.colors[1].slice(0,3));
obj.specular = new Float32Array(obj.colors[2].slice(0,3));
obj.lightDir = new Float32Array(obj.vertices[0]);
return;
}
if (type === "clipplanes") {
obj.vClipplane = this.flatten(this.cbind(obj.normals, obj.offsets));
return;
}
if (type == "background" && typeof obj.ids !== "undefined") {
obj.quad = this.flatten([].concat(obj.ids));
return;
}
if (typeof obj.vertices === "undefined")
obj.vertices = [];
v = obj.vertices;
obj.vertexCount = v.length;
if (!obj.vertexCount) return;
if (!sprites_3d) {
if (gl.isContextLost()) return;
obj.prog = gl.createProgram();
gl.attachShader(obj.prog, this.getShader( gl.VERTEX_SHADER,
this.getVertexShader(id) ));
gl.attachShader(obj.prog, this.getShader( gl.FRAGMENT_SHADER,
this.getFragmentShader(id) ));
//  Force aPos to location 0, aCol to location 1
gl.bindAttribLocation(obj.prog, 0, "aPos");
gl.bindAttribLocation(obj.prog, 1, "aCol");
gl.linkProgram(obj.prog);
var linked = gl.getProgramParameter(obj.prog, gl.LINK_STATUS);
if (!linked) {
// An error occurred while linking
var lastError = gl.getProgramInfoLog(obj.prog);
console.warn("Error in program linking:" + lastError);
gl.deleteProgram(obj.prog);
return;
}
}
if (type === "text") {
texinfo = this.drawTextToCanvas(obj.texts,
this.flatten(obj.cex),
this.flatten(obj.family),
this.flatten(obj.family));
}
if (fixed_quads && !sprites_3d) {
obj.ofsLoc = gl.getAttribLocation(obj.prog, "aOfs");
}
if (sprite_3d) {
obj.origLoc = gl.getUniformLocation(obj.prog, "uOrig");
obj.sizeLoc = gl.getUniformLocation(obj.prog, "uSize");
obj.usermatLoc = gl.getUniformLocation(obj.prog, "usermat");
}
if (has_texture || type == "text") {
obj.texture = gl.createTexture();
obj.texLoc = gl.getAttribLocation(obj.prog, "aTexcoord");
obj.sampler = gl.getUniformLocation(obj.prog, "uSampler");
}
if (has_texture) {
mat = obj.material;
if (typeof mat.uri !== "undefined")
uri = mat.uri;
else if (typeof mat.uriElementId === "undefined") {
matobj = this.getObj(mat.uriId);
if (typeof matobj !== "undefined") {
uri = matobj.material.uri;
} else {
uri = "";
}
} else
uri = document.getElementById(mat.uriElementId).rglinstance.getObj(mat.uriId).material.uri;
this.loadImageToTexture(uri, obj.texture);
}
if (type === "text") {
this.handleLoadedTexture(obj.texture, this.textureCanvas);
}
var stride = 3, nc, cofs, nofs, radofs, oofs, tofs, vnew, v1;
nc = obj.colorCount = obj.colors.length;
if (nc > 1) {
cofs = stride;
stride = stride + 4;
v = this.cbind(v, obj.colors);
} else {
cofs = -1;
obj.onecolor = this.flatten(obj.colors);
}
if (typeof obj.normals !== "undefined") {
nofs = stride;
stride = stride + 3;
v = this.cbind(v, typeof obj.pnormals !== "undefined" ? obj.pnormals : obj.normals);
} else
nofs = -1;
if (typeof obj.radii !== "undefined") {
radofs = stride;
stride = stride + 1;
if (obj.radii.length === v.length) {
v = this.cbind(v, obj.radii);
} else if (obj.radii.length === 1) {
v = v.map(function(row, i, arr) { return row.concat(obj.radii[0]);});
}
} else
radofs = -1;
if (type == "sprites" && !sprites_3d) {
tofs = stride;
stride += 2;
oofs = stride;
stride += 2;
vnew = new Array(4*v.length);
var size = obj.radii, s = size[0]/2;
for (i=0; i < v.length; i++) {
if (size.length > 1)
s = size[i]/2;
vnew[4*i]  = v[i].concat([0,0,-s,-s]);
vnew[4*i+1]= v[i].concat([1,0, s,-s]);
vnew[4*i+2]= v[i].concat([1,1, s, s]);
vnew[4*i+3]= v[i].concat([0,1,-s, s]);
}
v = vnew;
obj.vertexCount = v.length;
} else if (type === "text") {
tofs = stride;
stride += 2;
oofs = stride;
stride += 2;
vnew = new Array(4*v.length);
for (i=0; i < v.length; i++) {
vnew[4*i]  = v[i].concat([0,-0.5]).concat(obj.adj[0]);
vnew[4*i+1]= v[i].concat([1,-0.5]).concat(obj.adj[0]);
vnew[4*i+2]= v[i].concat([1, 1.5]).concat(obj.adj[0]);
vnew[4*i+3]= v[i].concat([0, 1.5]).concat(obj.adj[0]);
for (j=0; j < 4; j++) {
v1 = vnew[4*i+j];
v1[tofs+2] = 2*(v1[tofs]-v1[tofs+2])*texinfo.widths[i];
v1[tofs+3] = 2*(v1[tofs+1]-v1[tofs+3])*texinfo.textHeights[i];
v1[tofs] *= texinfo.widths[i]/texinfo.canvasX;
v1[tofs+1] = 1.0-(texinfo.offsets[i] -
v1[tofs+1]*texinfo.textHeights[i])/texinfo.canvasY;
vnew[4*i+j] = v1;
}
}
v = vnew;
obj.vertexCount = v.length;
} else if (typeof obj.texcoords !== "undefined") {
tofs = stride;
stride += 2;
oofs = -1;
v = this.cbind(v, obj.texcoords);
} else {
tofs = -1;
oofs = -1;
}
if (stride !== v[0].length) {
this.alertOnce("problem in stride calculation");
}
obj.vOffsets = {vofs:0, cofs:cofs, nofs:nofs, radofs:radofs, oofs:oofs, tofs:tofs, stride:stride};
obj.values = new Float32Array(this.flatten(v));
if (sprites_3d) {
obj.userMatrix = new CanvasMatrix4(obj.userMatrix);
obj.objects = this.flatten([].concat(obj.ids));
is_lit = false;
}
if (is_lit && !fixed_quads) {
obj.normLoc = gl.getAttribLocation(obj.prog, "aNorm");
}
nclipplanes = this.countClipplanes();
if (nclipplanes && !sprites_3d) {
obj.clipLoc = [];
for (i=0; i < nclipplanes; i++)
obj.clipLoc[i] = gl.getUniformLocation(obj.prog,"vClipplane" + i);
}
if (is_lit) {
obj.emissionLoc = gl.getUniformLocation(obj.prog, "emission");
obj.emission = new Float32Array(this.stringToRgb(this.getMaterial(id, "emission")));
obj.shininessLoc = gl.getUniformLocation(obj.prog, "shininess");
obj.shininess = this.getMaterial(id, "shininess");
obj.nlights = this.countLights();
obj.ambientLoc = [];
obj.ambient = new Float32Array(this.stringToRgb(this.getMaterial(id, "ambient")));
obj.specularLoc = [];
obj.specular = new Float32Array(this.stringToRgb(this.getMaterial(id, "specular")));
obj.diffuseLoc = [];
obj.lightDirLoc = [];
obj.viewpointLoc = [];
obj.finiteLoc = [];
for (i=0; i < obj.nlights; i++) {
obj.ambientLoc[i] = gl.getUniformLocation(obj.prog, "ambient" + i);
obj.specularLoc[i] = gl.getUniformLocation(obj.prog, "specular" + i);
obj.diffuseLoc[i] = gl.getUniformLocation(obj.prog, "diffuse" + i);
obj.lightDirLoc[i] = gl.getUniformLocation(obj.prog, "lightDir" + i);
obj.viewpointLoc[i] = gl.getUniformLocation(obj.prog, "viewpoint" + i);
obj.finiteLoc[i] = gl.getUniformLocation(obj.prog, "finite" + i);
}
}
if (is_indexed) {
if ((type === "quads" || type === "text" ||
type === "sprites") && !sprites_3d) {
nrows = Math.floor(obj.vertexCount/4);
f = Array(6*nrows);
for (i=0; i < nrows; i++) {
f[6*i] = 4*i;
f[6*i+1] = 4*i + 1;
f[6*i+2] = 4*i + 2;
f[6*i+3] = 4*i;
f[6*i+4] = 4*i + 2;
f[6*i+5] = 4*i + 3;
}
frowsize = 6;
} else if (type === "triangles") {
nrows = Math.floor(obj.vertexCount/3);
f = Array(3*nrows);
for (i=0; i < f.length; i++) {
f[i] = i;
}
frowsize = 3;
} else if (type === "spheres") {
nrows = obj.vertexCount;
f = Array(nrows);
for (i=0; i < f.length; i++) {
f[i] = i;
}
frowsize = 1;
} else if (type === "surface") {
var dim = obj.dim[0],
nx = dim[0],
nz = dim[1];
f = [];
for (j=0; j<nx-1; j++) {
for (i=0; i<nz-1; i++) {
f.push(j + nx*i,
j + nx*(i+1),
j + 1 + nx*(i+1),
j + nx*i,
j + 1 + nx*(i+1),
j + 1 + nx*i);
}
}
frowsize = 6;
}
obj.f = new Uint16Array(f);
if (depth_sort) {
drawtype = "DYNAMIC_DRAW";
} else {
drawtype = "STATIC_DRAW";
}
}
if (type !== "spheres" && !sprites_3d) {
obj.buf = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, obj.values, gl.STATIC_DRAW); //
}
if (is_indexed && type !== "spheres" && !sprites_3d) {
obj.ibuf = gl.createBuffer();
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, obj.ibuf);
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, obj.f, gl[drawtype]);
}
if (!sprites_3d) {
obj.mvMatLoc = gl.getUniformLocation(obj.prog, "mvMatrix");
obj.prMatLoc = gl.getUniformLocation(obj.prog, "prMatrix");
}
if (type === "text") {
obj.textScaleLoc = gl.getUniformLocation(obj.prog, "textScale");
}
if (is_lit && !sprites_3d) {
obj.normMatLoc = gl.getUniformLocation(obj.prog, "normMatrix");
}
};
this.setDepthTest = function(id) {
var gl = this.gl || this.initGL(),
tests = {never: gl.NEVER,
less:  gl.LESS,
equal: gl.EQUAL,
lequal:gl.LEQUAL,
greater: gl.GREATER,
notequal: gl.NOTEQUAL,
gequal: gl.GEQUAL,
always: gl.ALWAYS},
test = tests[this.getMaterial(id, "depth_test")];
gl.depthFunc(test);
};
this.mode4type = {points : "POINTS",
linestrip : "LINE_STRIP",
abclines : "LINES",
lines : "LINES",
sprites : "TRIANGLES",
planes : "TRIANGLES",
text : "TRIANGLES",
quads : "TRIANGLES",
surface : "TRIANGLES",
triangles : "TRIANGLES"};
this.drawObj = function(id, subsceneid) {
var obj = this.getObj(id),
subscene = this.getObj(subsceneid),
flags = obj.flags,
type = obj.type,
is_indexed = flags & this.f_is_indexed,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
depth_sort = flags & this.f_depth_sort,
sprites_3d = flags & this.f_sprites_3d,
sprite_3d = flags & this.f_sprite_3d,
is_lines = flags & this.f_is_lines,
gl = this.gl || this.initGL(),
sphereMV, baseofs, ofs, sscale, i, count, light,
faces;
if (typeof id !== "number") {
this.alertOnce("drawObj id is "+typeof id);
}
if (type === "planes") {
if (obj.bbox !== subscene.par3d.bbox || !obj.initialized) {
this.planeUpdateTriangles(id, subscene.par3d.bbox);
}
}
if (!obj.initialized)
this.initObj(id);
if (type === "clipplanes") {
count = obj.offsets.length;
var IMVClip = [];
for (i=0; i < count; i++) {
IMVClip[i] = this.multMV(this.invMatrix, obj.vClipplane.slice(4*i, 4*(i+1)));
}
obj.IMVClip = IMVClip;
return;
}
if (type === "light" || type === "bboxdeco" || !obj.vertexCount)
return;
this.setDepthTest(id);
if (sprites_3d) {
var norigs = obj.vertices.length,
savenorm = new CanvasMatrix4(this.normMatrix);
this.origs = obj.vertices;
this.usermat = new Float32Array(obj.userMatrix.getAsArray());
this.radii = obj.radii;
this.normMatrix = subscene.spriteNormmat;
for (this.iOrig=0; this.iOrig < norigs; this.iOrig++) {
for (i=0; i < obj.objects.length; i++) {
this.drawObj(obj.objects[i], subsceneid);
}
}
this.normMatrix = savenorm;
return;
} else {
gl.useProgram(obj.prog);
}
if (sprite_3d) {
gl.uniform3fv(obj.origLoc, new Float32Array(this.origs[this.iOrig]));
if (this.radii.length > 1) {
gl.uniform1f(obj.sizeLoc, this.radii[this.iOrig][0]);
} else {
gl.uniform1f(obj.sizeLoc, this.radii[0][0]);
}
gl.uniformMatrix4fv(obj.usermatLoc, false, this.usermat);
}
if (type === "spheres") {
gl.bindBuffer(gl.ARRAY_BUFFER, this.sphere.buf);
} else {
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
}
if (is_indexed && type !== "spheres") {
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, obj.ibuf);
} else if (type === "spheres") {
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.sphere.ibuf);
}
gl.uniformMatrix4fv( obj.prMatLoc, false, new Float32Array(this.prMatrix.getAsArray()) );
gl.uniformMatrix4fv( obj.mvMatLoc, false, new Float32Array(this.mvMatrix.getAsArray()) );
var clipcheck = 0,
clipplaneids = subscene.clipplanes,
clip, j;
for (i=0; i < clipplaneids.length; i++) {
clip = this.getObj(clipplaneids[i]);
for (j=0; j < clip.offsets.length; j++) {
gl.uniform4fv(obj.clipLoc[clipcheck + j], clip.IMVClip[j]);
}
clipcheck += clip.offsets.length;
}
if (typeof obj.clipLoc !== "undefined")
for (i=clipcheck; i < obj.clipLoc.length; i++)
gl.uniform4f(obj.clipLoc[i], 0,0,0,0);
if (is_lit) {
gl.uniformMatrix4fv( obj.normMatLoc, false, new Float32Array(this.normMatrix.getAsArray()) );
gl.uniform3fv( obj.emissionLoc, obj.emission);
gl.uniform1f( obj.shininessLoc, obj.shininess);
for (i=0; i < subscene.lights.length; i++) {
light = this.getObj(subscene.lights[i]);
gl.uniform3fv( obj.ambientLoc[i], this.componentProduct(light.ambient, obj.ambient));
gl.uniform3fv( obj.specularLoc[i], this.componentProduct(light.specular, obj.specular));
gl.uniform3fv( obj.diffuseLoc[i], light.diffuse);
gl.uniform3fv( obj.lightDirLoc[i], light.lightDir);
gl.uniform1i( obj.viewpointLoc[i], light.viewpoint);
gl.uniform1i( obj.finiteLoc[i], light.finite);
}
for (i=subscene.lights.length; i < obj.nlights; i++) {
gl.uniform3f( obj.ambientLoc[i], 0,0,0);
gl.uniform3f( obj.specularLoc[i], 0,0,0);
gl.uniform3f( obj.diffuseLoc[i], 0,0,0);
}
}
if (type === "text") {
gl.uniform2f( obj.textScaleLoc, 0.75/this.vp.width, 0.75/this.vp.height);
}
gl.enableVertexAttribArray( this.posLoc );
var nc = obj.colorCount;
count = obj.vertexCount;
if (depth_sort) {
var nfaces = obj.centers.length,
frowsize, z, w;
if (sprites_3d) frowsize = 1;
else if (type === "triangles") frowsize = 3;
else frowsize = 6;
var depths = new Float32Array(nfaces);
faces = new Array(nfaces);
for(i=0; i<nfaces; i++) {
z = this.prmvMatrix.m13*obj.centers[3*i] +
this.prmvMatrix.m23*obj.centers[3*i+1] +
this.prmvMatrix.m33*obj.centers[3*i+2] +
this.prmvMatrix.m43;
w = this.prmvMatrix.m14*obj.centers[3*i] +
this.prmvMatrix.m24*obj.centers[3*i+1] +
this.prmvMatrix.m34*obj.centers[3*i+2] +
this.prmvMatrix.m44;
depths[i] = z/w;
faces[i] = i;
}
var depthsort = function(i,j) { return depths[j] - depths[i]; };
faces.sort(depthsort);
if (type !== "spheres") {
var f = new Uint16Array(obj.f.length);
for (i=0; i<nfaces; i++) {
for (j=0; j<frowsize; j++) {
f[frowsize*i + j] = obj.f[frowsize*faces[i] + j];
}
}
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, f, gl.DYNAMIC_DRAW);
}
}
if (type === "spheres") {
subscene = this.getObj(subsceneid);
var scale = subscene.par3d.scale,
scount = count;
gl.vertexAttribPointer(this.posLoc,  3, gl.FLOAT, false, 4*this.sphere.vOffsets.stride,  0);
gl.enableVertexAttribArray(obj.normLoc );
gl.vertexAttribPointer(obj.normLoc,  3, gl.FLOAT, false, 4*this.sphere.vOffsets.stride,  0);
gl.disableVertexAttribArray( this.colLoc );
var sphereNorm = new CanvasMatrix4();
sphereNorm.scale(scale[0], scale[1], scale[2]);
sphereNorm.multRight(this.normMatrix);
gl.uniformMatrix4fv( obj.normMatLoc, false, new Float32Array(sphereNorm.getAsArray()) );
if (nc == 1) {
gl.vertexAttrib4fv( this.colLoc, new Float32Array(obj.onecolor));
}
if (has_texture) {
gl.enableVertexAttribArray( obj.texLoc );
gl.vertexAttribPointer(obj.texLoc, 2, gl.FLOAT, false, 4*this.sphere.vOffsets.stride, 4*this.sphere.vOffsets.tofs);
gl.activeTexture(gl.TEXTURE0);
gl.bindTexture(gl.TEXTURE_2D, obj.texture);
gl.uniform1i( obj.sampler, 0);
}
for (i = 0; i < scount; i++) {
sphereMV = new CanvasMatrix4();
if (depth_sort) {
baseofs = faces[i]*obj.vOffsets.stride;
} else {
baseofs = i*obj.vOffsets.stride;
}
ofs = baseofs + obj.vOffsets.radofs;
sscale = obj.values[ofs];
sphereMV.scale(sscale/scale[0], sscale/scale[1], sscale/scale[2]);
sphereMV.translate(obj.values[baseofs],
obj.values[baseofs+1],
obj.values[baseofs+2]);
sphereMV.multRight(this.mvMatrix);
gl.uniformMatrix4fv( obj.mvMatLoc, false, new Float32Array(sphereMV.getAsArray()) );
if (nc > 1) {
ofs = baseofs + obj.vOffsets.cofs;
gl.vertexAttrib4f( this.colLoc, obj.values[ofs],
obj.values[ofs+1],
obj.values[ofs+2],
obj.values[ofs+3] );
}
gl.drawElements(gl.TRIANGLES, this.sphere.sphereCount, gl.UNSIGNED_SHORT, 0);
}
return;
} else {
if (obj.colorCount === 1) {
gl.disableVertexAttribArray( this.colLoc );
gl.vertexAttrib4fv( this.colLoc, new Float32Array(obj.onecolor));
} else {
gl.enableVertexAttribArray( this.colLoc );
gl.vertexAttribPointer(this.colLoc, 4, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.cofs);
}
}
if (is_lit && obj.vOffsets.nofs > 0) {
gl.enableVertexAttribArray( obj.normLoc );
gl.vertexAttribPointer(obj.normLoc, 3, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.nofs);
}
if (has_texture || type === "text") {
gl.enableVertexAttribArray( obj.texLoc );
gl.vertexAttribPointer(obj.texLoc, 2, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.tofs);
gl.activeTexture(gl.TEXTURE0);
gl.bindTexture(gl.TEXTURE_2D, obj.texture);
gl.uniform1i( obj.sampler, 0);
}
if (fixed_quads) {
gl.enableVertexAttribArray( obj.ofsLoc );
gl.vertexAttribPointer(obj.ofsLoc, 2, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.oofs);
}
var mode = this.mode4type[type];
if (type === "sprites" || type === "text" || type === "quads") {
count = count * 6/4;
} else if (type === "surface") {
count = obj.f.length;
}
if (is_lines) {
gl.lineWidth( this.getMaterial(id, "lwd") );
}
gl.vertexAttribPointer(this.posLoc,  3, gl.FLOAT, false, 4*obj.vOffsets.stride,  4*obj.vOffsets.vofs);
if (is_indexed) {
gl.drawElements(gl[mode], count, gl.UNSIGNED_SHORT, 0);
} else {
gl.drawArrays(gl[mode], 0, count);
}
};
this.drawBackground = function(id, subsceneid) {
var gl = this.gl || this.initGL(),
obj = this.getObj(id),
bg, i;
if (!obj.initialized)
this.initObj(id);
if (obj.colors.length) {
bg = obj.colors[0];
gl.clearColor(bg[0], bg[1], bg[2], bg[3]);
gl.depthMask(true);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
}
if (typeof obj.quad !== "undefined") {
this.prMatrix.makeIdentity();
this.mvMatrix.makeIdentity();
gl.disable(gl.BLEND);
gl.disable(gl.DEPTH_TEST);
gl.depthMask(false);
for (i=0; i < obj.quad.length; i++)
this.drawObj(obj.quad[i], subsceneid);
}
};
this.drawSubscene = function(subsceneid) {
var gl = this.gl || this.initGL(),
obj = this.getObj(subsceneid),
objects = this.scene.objects,
subids = obj.objects,
subscene_has_faces = false,
subscene_needs_sorting = false,
flags, i;
if (obj.par3d.skipRedraw)
return;
for (i=0; i < subids.length; i++) {
flags = objects[subids[i]].flags;
if (typeof flags !== "undefined") {
subscene_has_faces |= (flags & this.f_is_lit)
& !(flags & this.f_fixed_quads);
subscene_needs_sorting |= (flags & this.f_depth_sort);
}
}
this.setViewport(subsceneid);
if (typeof obj.backgroundId !== "undefined")
this.drawBackground(obj.backgroundId, subsceneid);
if (subids.length) {
this.setprMatrix(subsceneid);
this.setmvMatrix(subsceneid);
if (subscene_has_faces) {
this.setnormMatrix(subsceneid);
if ((obj.flags & this.f_sprites_3d) &&
typeof obj.spriteNormmat === "undefined") {
obj.spriteNormmat = new CanvasMatrix4(this.normMatrix);
}
}
if (subscene_needs_sorting)
this.setprmvMatrix();
gl.enable(gl.DEPTH_TEST);
gl.depthMask(true);
gl.disable(gl.BLEND);
var clipids = obj.clipplanes;
if (typeof clipids === "undefined") {
console.warn("bad clipids");
}
if (clipids.length > 0) {
this.invMatrix = new CanvasMatrix4(this.mvMatrix);
this.invMatrix.invert();
for (i = 0; i < clipids.length; i++)
this.drawObj(clipids[i], subsceneid);
}
subids = obj.opaque;
if (subids.length > 0) {
for (i = 0; i < subids.length; i++) {
this.drawObj(subids[i], subsceneid);
}
}
subids = obj.transparent;
if (subids.length > 0) {
gl.depthMask(false);
gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA,
gl.ONE, gl.ONE);
gl.enable(gl.BLEND);
for (i = 0; i < subids.length; i++) {
this.drawObj(subids[i], subsceneid);
}
}
subids = obj.subscenes;
for (i = 0; i < subids.length; i++) {
this.drawSubscene(subids[i]);
}
}
};
this.relMouseCoords = function(event) {
var totalOffsetX = 0,
totalOffsetY = 0,
currentElement = this.canvas;
do {
totalOffsetX += currentElement.offsetLeft;
totalOffsetY += currentElement.offsetTop;
currentElement = currentElement.offsetParent;
}
while(currentElement);
var canvasX = event.pageX - totalOffsetX,
canvasY = event.pageY - totalOffsetY;
return {x:canvasX, y:canvasY};
};
this.setMouseHandlers = function() {
var self = this, activeSubscene, handler,
handlers = {}, drag = 0;
handlers.rotBase = 0;
this.screenToVector = function(x, y) {
var viewport = this.getObj(activeSubscene).par3d.viewport,
width = viewport.width*this.canvas.width,
height = viewport.height*this.canvas.height,
radius = Math.max(width, height)/2.0,
cx = width/2.0,
cy = height/2.0,
px = (x-cx)/radius,
py = (y-cy)/radius,
plen = Math.sqrt(px*px+py*py);
if (plen > 1.e-6) {
px = px/plen;
py = py/plen;
}
var angle = (Math.SQRT2 - plen)/Math.SQRT2*Math.PI/2,
z = Math.sin(angle),
zlen = Math.sqrt(1.0 - z*z);
px = px * zlen;
py = py * zlen;
return [px, py, z];
};
handlers.trackballdown = function(x,y) {
var activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
i, l = activeModel.par3d.listeners;
handlers.rotBase = this.screenToVector(x, y);
this.saveMat = [];
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.saveMat = new CanvasMatrix4(activeSub.par3d.userMatrix);
}
};
handlers.trackballmove = function(x,y) {
var rotCurrent = this.screenToVector(x,y),
rotBase = handlers.rotBase,
dot = rotBase[0]*rotCurrent[0] +
rotBase[1]*rotCurrent[1] +
rotBase[2]*rotCurrent[2],
angle = Math.acos( dot/this.vlen(rotBase)/this.vlen(rotCurrent) )*180.0/Math.PI,
axis = this.xprod(rotBase, rotCurrent),
objects = this.scene.objects,
activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
l = activeModel.par3d.listeners,
i;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.userMatrix.load(objects[l[i]].saveMat);
activeSub.par3d.userMatrix.rotate(angle, axis[0], axis[1], axis[2]);
}
this.drawScene();
};
handlers.trackballend = 0;
handlers.axisdown = function(x,y) {
handlers.rotBase = this.screenToVector(x, this.canvas.height/2);
var activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
i, l = activeModel.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.saveMat = new CanvasMatrix4(activeSub.par3d.userMatrix);
}
};
handlers.axismove = function(x,y) {
var rotCurrent = this.screenToVector(x, this.canvas.height/2),
rotBase = handlers.rotBase,
angle = (rotCurrent[0] - rotBase[0])*180/Math.PI,
rotMat = new CanvasMatrix4();
rotMat.rotate(angle, handlers.axis[0], handlers.axis[1], handlers.axis[2]);
var activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
i, l = activeModel.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.userMatrix.load(activeSub.saveMat);
activeSub.par3d.userMatrix.multLeft(rotMat);
}
this.drawScene();
};
handlers.axisend = 0;
handlers.y0zoom = 0;
handlers.zoom0 = 0;
handlers.zoomdown = function(x, y) {
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
handlers.y0zoom = y;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.zoom0 = Math.log(activeSub.par3d.zoom);
}
};
handlers.zoommove = function(x, y) {
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.zoom = Math.exp(activeSub.zoom0 + (y-handlers.y0zoom)/this.canvas.height);
}
this.drawScene();
};
handlers.zoomend = 0;
handlers.y0fov = 0;
handlers.fovdown = function(x, y) {
handlers.y0fov = y;
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.fov0 = activeSub.par3d.FOV;
}
};
handlers.fovmove = function(x, y) {
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.FOV = Math.max(1, Math.min(179, activeSub.fov0 +
180*(y-handlers.y0fov)/this.canvas.height));
}
this.drawScene();
};
handlers.fovend = 0;
this.canvas.onmousedown = function ( ev ){
if (!ev.which) // Use w3c defns in preference to MS
switch (ev.button) {
case 0: ev.which = 1; break;
case 1:
case 4: ev.which = 2; break;
case 2: ev.which = 3;
}
drag = ["left", "middle", "right"][ev.which-1];
var coords = self.relMouseCoords(ev);
coords.y = self.canvas.height-coords.y;
activeSubscene = self.whichSubscene(coords);
var sub = self.getObj(activeSubscene), f;
handler = sub.par3d.mouseMode[drag];
switch (handler) {
case "xAxis":
handler = "axis";
handlers.axis = [1.0, 0.0, 0.0];
break;
case "yAxis":
handler = "axis";
handlers.axis = [0.0, 1.0, 0.0];
break;
case "zAxis":
handler = "axis";
handlers.axis = [0.0, 0.0, 1.0];
break;
}
f = handlers[handler + "down"];
if (f) {
coords = self.translateCoords(activeSubscene, coords);
f.call(self, coords.x, coords.y);
ev.preventDefault();
}
};
this.canvas.onmouseup = function ( ev ){
if ( drag === 0 ) return;
var f = handlers[handler + "up"];
if (f)
f();
drag = 0;
};
this.canvas.onmouseout = this.canvas.onmouseup;
this.canvas.onmousemove = function ( ev ) {
if ( drag === 0 ) return;
var f = handlers[handler + "move"];
if (f) {
var coords = self.relMouseCoords(ev);
coords.y = self.canvas.height - coords.y;
coords = self.translateCoords(activeSubscene, coords);
f.call(self, coords.x, coords.y);
}
};
handlers.wheelHandler = function(ev) {
var del = 1.02, i;
if (ev.shiftKey) del = 1.002;
var ds = ((ev.detail || ev.wheelDelta) > 0) ? del : (1 / del);
if (typeof activeSubscene === "undefined")
activeSubscene = self.scene.rootSubscene;
var activeSub = self.getObj(activeSubscene),
activeProjection = self.getObj(self.useid(activeSub.id, "projection")),
l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = self.getObj(l[i]);
activeSub.par3d.zoom *= ds;
}
self.drawScene();
ev.preventDefault();
};
this.canvas.addEventListener("DOMMouseScroll", handlers.wheelHandler, false);
this.canvas.addEventListener("mousewheel", handlers.wheelHandler, false);
};
this.useid = function(subsceneid, type) {
var sub = this.getObj(subsceneid);
if (sub.embeddings[type] === "inherit")
return(this.useid(sub.parent, type));
else
return subsceneid;
};
this.inViewport = function(coords, subsceneid) {
var viewport = this.getObj(subsceneid).par3d.viewport,
x0 = coords.x - viewport.x*this.canvas.width,
y0 = coords.y - viewport.y*this.canvas.height;
return 0 <= x0 && x0 <= viewport.width*this.canvas.width &&
0 <= y0 && y0 <= viewport.height*this.canvas.height;
};
this.whichSubscene = function(coords) {
var self = this,
recurse = function(subsceneid) {
var subscenes = self.getChildSubscenes(subsceneid), i, id;
for (i=0; i < subscenes.length; i++) {
id = recurse(subscenes[i]);
if (typeof(id) !== "undefined")
return(id);
}
if (self.inViewport(coords, subsceneid))
return(subsceneid);
else
return undefined;
},
rootid = this.scene.rootSubscene,
result = recurse(rootid);
if (typeof(result) === "undefined")
result = rootid;
return result;
};
this.translateCoords = function(subsceneid, coords) {
var viewport = this.getObj(subsceneid).par3d.viewport;
return {x: coords.x - viewport.x*this.canvas.width,
y: coords.y - viewport.y*this.canvas.height};
};
this.initSphere = function() {
var verts = this.scene.sphereVerts, 
reuse = verts.reuse, result;
if (typeof reuse !== "undefined") {
var prev = document.getElementById(reuse).rglinstance.sphere;
result = {values: prev.values, vOffsets: prev.vOffsets, it: prev.it};
} else 
result = {values: new Float32Array(this.flatten(this.cbind(this.transpose(verts.vb),
this.transpose(verts.texcoords)))),
it: new Uint16Array(this.flatten(this.transpose(verts.it))),
vOffsets: {vofs:0, cofs:-1, nofs:-1, radofs:-1, oofs:-1, 
tofs:3, stride:5}};
result.sphereCount = result.it.length;
this.sphere = result;
};
this.initSphereGL = function() {
var gl = this.gl || this.initGL(), sphere = this.sphere;
if (gl.isContextLost()) return;
sphere.buf = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, sphere.buf);
gl.bufferData(gl.ARRAY_BUFFER, sphere.values, gl.STATIC_DRAW);
sphere.ibuf = gl.createBuffer();
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, sphere.ibuf);
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, sphere.it, gl.STATIC_DRAW);
return;
};
this.initialize = function(el, x) {
this.textureCanvas = document.createElement("canvas");
this.textureCanvas.style.display = "block";
this.scene = x;
this.normMatrix = new CanvasMatrix4();
this.saveMat = {};
this.distance = null;
this.posLoc = 0;
this.colLoc = 1;
if (el) {
el.rglinstance = this;
this.el = el;
this.webGLoptions = el.rglinstance.scene.webGLoptions;
this.initCanvas();
}
};
this.restartCanvas = function() {
var newcanvas = document.createElement("canvas");
newcanvas.width = this.el.width;
newcanvas.height = this.el.height;
newcanvas.addEventListener("webglcontextrestored",
this.onContextRestored, false);
newcanvas.addEventListener("webglcontextlost",
this.onContextLost, false);            
while (this.el.firstChild) {
this.el.removeChild(this.el.firstChild);
}
this.el.appendChild(newcanvas);
this.canvas = newcanvas;
this.gl = null;         
}
this.initCanvas = function() {
this.restartCanvas();
var objs = this.scene.objects,
self = this;
Object.keys(objs).forEach(function(key){
var id = parseInt(key, 10),
obj = self.getObj(id);
if (typeof obj.reuse !== "undefined")
self.copyObj(id, obj.reuse);
});
Object.keys(objs).forEach(function(key){
self.initSubscene(parseInt(key, 10));
});
this.setMouseHandlers();      
this.initSphere();
this.onContextRestored = function(event) {
self.initGL();
self.drawScene();
console.log("restored context for "+self.scene.rootSubscene);
}
this.onContextLost = function(event) {
if (!self.drawing)
self.restartCanvas();
event.preventDefault();
}
this.initGL0();
lazyLoadScene = function() {
if (self.isInBrowserViewport()) {
if (!self.gl) {
self.initGL();
}
self.drawScene();
}
}
window.addEventListener("DOMContentLoaded", lazyLoadScene, false);
window.addEventListener("load", lazyLoadScene, false);
window.addEventListener("resize", lazyLoadScene, false);
window.addEventListener("scroll", lazyLoadScene, false);
};
/* this is only used by writeWebGL; rglwidget has
no debug element and does the drawing in rglwidget.js */
this.start = function() {
if (typeof this.prefix !== "undefined") {
this.debugelement = document.getElementById(this.prefix + "debug");
this.debug("");
}
this.drag = 0;
this.drawScene();
};
this.debug = function(msg, img) {
if (typeof this.debugelement !== "undefined" && this.debugelement !== null) {
this.debugelement.innerHTML = msg;
if (typeof img !== "undefined") {
this.debugelement.insertBefore(img, this.debugelement.firstChild);
}
} else if (msg !== "")
alert(msg);
};
this.getSnapshot = function() {
var img;
if (typeof this.scene.snapshot !== "undefined") {
img = document.createElement("img");
img.src = this.scene.snapshot;
img.alt = "Snapshot";
}
return img;
};
this.initGL0 = function() {
if (!window.WebGLRenderingContext){
alert("Your browser does not support WebGL. See http://get.webgl.org");
return;
}
};
this.isInBrowserViewport = function() {
var rect = this.canvas.getBoundingClientRect(),
windHeight = (window.innerHeight || document.documentElement.clientHeight),
windWidth = (window.innerWidth || document.documentElement.clientWidth);
return (
rect.top >= -windHeight &&
rect.left >= -windWidth &&
rect.bottom <= 2*windHeight &&
rect.right <= 2*windWidth);
}
this.initGL = function() {
var self = this;
if (this.gl) {
if (!this.drawing && this.gl.isContextLost())
this.restartCanvas();
else
return this.gl;
}
// if (!this.isInBrowserViewport()) return; Return what??? At this point we know this.gl is null.
this.canvas.addEventListener("webglcontextrestored",
this.onContextRestored, false);
this.canvas.addEventListener("webglcontextlost",
this.onContextLost, false);      
this.gl = this.canvas.getContext("webgl", this.webGLoptions) ||
this.canvas.getContext("experimental-webgl", this.webGLoptions);
var save = this.startDrawing();
this.initSphereGL(); 
Object.keys(this.scene.objects).forEach(function(key){
self.initObj(parseInt(key, 10));
});
this.stopDrawing(save);
return this.gl;
};
this.resize = function(el) {
this.canvas.width = el.width;
this.canvas.height = el.height;
};
this.drawScene = function() {
var gl = this.gl || this.initGL(),
save = this.startDrawing();
gl.enable(gl.DEPTH_TEST);
gl.depthFunc(gl.LEQUAL);
gl.clearDepth(1.0);
gl.clearColor(1,1,1,1);
gl.depthMask(true); // Must be true before clearing depth buffer
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
this.drawSubscene(this.scene.rootSubscene);
this.stopDrawing(save);
};
this.subsetSetter = function(el, control) {
if (typeof control.subscenes === "undefined" ||
control.subscenes === null)
control.subscenes = this.scene.rootSubscene;
var value = Math.round(control.value),
subscenes = [].concat(control.subscenes),
i, j, entries, subsceneid,
ismissing = function(x) {
return control.fullset.indexOf(x) < 0;
},
tointeger = function(x) {
return parseInt(x, 10);
};
for (i=0; i < subscenes.length; i++) {
subsceneid = subscenes[i];
if (typeof this.getObj(subsceneid) === "undefined")
this.alertOnce("typeof object is undefined");
entries = this.getObj(subsceneid).objects;
entries = entries.filter(ismissing);
if (control.accumulate) {
for (j=0; j<=value; j++)
entries = entries.concat(control.subsets[j]);
} else {
entries = entries.concat(control.subsets[value]);
}
entries = entries.map(tointeger);
this.setSubsceneEntries(this.unique(entries), subsceneid);
}
};
this.propertySetter = function(el, control)  {
var value = control.value,
values = [].concat(control.values),
svals = [].concat(control.param),
direct = values[0] === null,
entries = [].concat(control.entries),
ncol = entries.length,
nrow = values.length/ncol,
properties = this.repeatToLen(control.properties, ncol),
objids = this.repeatToLen(control.objids, ncol),
property = properties[0], objid = objids[0],
obj = this.getObj(objid),
propvals, i, v1, v2, p, entry, gl, needsBinding,
newprop, newid,
getPropvals = function() {
if (property === "userMatrix")
return obj.userMatrix.getAsArray();
else
return obj[property];
};
if (direct && typeof value === "undefined")
return;
if (control.interp) {
values = values.slice(0, ncol).concat(values).
concat(values.slice(ncol*(nrow-1), ncol*nrow));
svals = [-Infinity].concat(svals).concat(Infinity);
for (i = 1; i < svals.length; i++) {
if (value <= svals[i]) {
if (svals[i] === Infinity)
p = 1;
else
p = (svals[i] - value)/(svals[i] - svals[i-1]);
break;
}
}
} else if (!direct) {
value = Math.round(value);
}
propvals = getPropvals();
for (j=0; j<entries.length; j++) {
entry = entries[j];
newprop = properties[j];
newid = objids[j];
if (newprop != property || newid != objid) {
property = newprop;
objid = newid;
obj = this.getObj(objid);
propvals = getPropvals();
}
if (control.interp) {
v1 = values[ncol*(i-1) + j];
v2 = values[ncol*i + j];
this.setElement(propvals, entry, p*v1 + (1-p)*v2);
} else if (!direct) {
this.setElement(propvals, entry, values[ncol*value + j]);
} else {
this.setElement(propvals, entry, value[j]);
}
}
needsBinding = [];
for (j=0; j < entries.length; j++) {
if (properties[j] === "values" &&
needsBinding.indexOf(objids[j]) === -1) {
needsBinding.push(objids[j]);
}
}
for (j=0; j < needsBinding.length; j++) {
gl = this.gl || this.initGL();
obj = this.getObj(needsBinding[j]);
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, obj.values, gl.STATIC_DRAW);
}
};
this.vertexSetter = function(el, control)  {
var svals = [].concat(control.param),
j, k, p, propvals, stride, ofs, obj,
attrib,
ofss    = {x:"vofs", y:"vofs", z:"vofs",
red:"cofs", green:"cofs", blue:"cofs",
alpha:"cofs", radii:"radofs",
nx:"nofs", ny:"nofs", nz:"nofs",
ox:"oofs", oy:"oofs", oz:"oofs",
ts:"tofs", tt:"tofs"},
pos     = {x:0, y:1, z:2,
red:0, green:1, blue:2,
alpha:3,radii:0,
nx:0, ny:1, nz:2,
ox:0, oy:1, oz:2,
ts:0, tt:1},
values = control.values,
direct = values === null,
ncol,
interp = control.interp,
vertices = [].concat(control.vertices),
attributes = [].concat(control.attributes),
value = control.value;
ncol = Math.max(vertices.length, attributes.length);
if (!ncol)
return;
vertices = this.repeatToLen(vertices, ncol);
attributes = this.repeatToLen(attributes, ncol);
if (direct)
interp = false;
/* JSON doesn't pass Infinity */
svals[0] = -Infinity;
svals[svals.length - 1] = Infinity;
for (j = 1; j < svals.length; j++) {
if (value <= svals[j]) {
if (interp) {
if (svals[j] === Infinity)
p = 1;
else
p = (svals[j] - value)/(svals[j] - svals[j-1]);
} else {
if (svals[j] - value > value - svals[j-1])
j = j - 1;
}
break;
}
}
obj = this.getObj(control.objid);
propvals = obj.values;
for (k=0; k<ncol; k++) {
attrib = attributes[k];
vertex = vertices[k];
ofs = obj.vOffsets[ofss[attrib]];
if (ofs < 0)
this.alertOnce("Attribute '"+attrib+"' not found in object "+control.objid);
else {
stride = obj.vOffsets.stride;
ofs = vertex*stride + ofs + pos[attrib];
if (direct) {
propvals[ofs] = value;
} else if (interp) {
propvals[ofs] = p*values[j-1][k] + (1-p)*values[j][k];
} else {
propvals[ofs] = values[j][k];
}
}
}
if (typeof obj.buf !== "undefined") {
var gl = this.gl || this.initGL();
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, propvals, gl.STATIC_DRAW);
}
};
this.ageSetter = function(el, control) {
var objids = [].concat(control.objids),
nobjs = objids.length,
time = control.value,
births = [].concat(control.births),
ages = [].concat(control.ages),
steps = births.length,
j = Array(steps),
p = Array(steps),
i, k, age, j0, propvals, stride, ofs, objid, obj,
attrib, dim,
attribs = ["colors", "alpha", "radii", "vertices",
"normals", "origins", "texcoords",
"x", "y", "z",
"red", "green", "blue"],
ofss    = ["cofs", "cofs", "radofs", "vofs",
"nofs", "oofs", "tofs",
"vofs", "vofs", "vofs",
"cofs", "cofs", "cofs"],
dims    = [3,1,1,3,
3,2,2,
1,1,1,
1,1,1],
pos     = [0,3,0,0,
0,0,0,
0,1,2,
0,1,2];
/* Infinity doesn't make it through JSON */
ages[0] = -Infinity;
ages[ages.length-1] = Infinity;
for (i = 0; i < steps; i++) {
if (births[i] !== null) {  // NA in R becomes null
age = time - births[i];
for (j0 = 1; age > ages[j0]; j0++);
if (ages[j0] == Infinity)
p[i] = 1;
else if (ages[j0] > ages[j0-1])
p[i] = (ages[j0] - age)/(ages[j0] - ages[j0-1]);
else
p[i] = 0;
j[i] = j0;
}
}
for (l = 0; l < nobjs; l++) {
objid = objids[l];
obj = this.getObj(objid);
propvals = obj.values;
stride = obj.vOffsets.stride;
for (k = 0; k < attribs.length; k++) {
attrib = control[attribs[k]];
if (typeof attrib !== "undefined") {
ofs = obj.vOffsets[ofss[k]];
if (ofs >= 0) {
dim = dims[k];
ofs = ofs + pos[k];
for (i = 0; i < steps; i++) {
if (births[i] !== null) {
for (d=0; d < dim; d++) {
propvals[i*stride + ofs + d] = p[i]*attrib[dim*(j[i]-1) + d] + (1-p[i])*attrib[dim*j[i] + d];
}
}
}
} else
this.alertOnce("\'"+attribs[k]+"\' property not found in object "+objid);
}
}
obj.values = propvals;
if (typeof obj.buf !== "undefined") {
gl = this.gl || this.initGL();
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, obj.values, gl.STATIC_DRAW);
}
}
};
this.oldBridge = function(el, control) {
var attrname, global = window[control.prefix + "rgl"];
if (typeof global !== "undefined")
for (attrname in global)
this[attrname] = global[attrname];
window[control.prefix + "rgl"] = this;
};
this.Player = function(el, control) {
var
self = this,
components = [].concat(control.components),
Tick = function() { /* "this" will be a timer */
var i,
nominal = this.value,
slider = this.Slider,
labels = this.outputLabels,
output = this.Output,
step;
if (typeof slider !== "undefined" && nominal != slider.value)
slider.value = nominal;
if (typeof output !== "undefined") {
step = Math.round((nominal - output.sliderMin)/output.sliderStep);
if (labels !== null) {
output.innerHTML = labels[step];
} else {
step = step*output.sliderStep + output.sliderMin;
output.innerHTML = step.toPrecision(output.outputPrecision);
}
}
for (i=0; i < this.actions.length; i++) {
this.actions[i].value = nominal;
}
self.applyControls(el, this.actions, false);
self.drawScene();
},
OnSliderInput = function() { /* "this" will be the slider */
this.rgltimer.value = Number(this.value);
this.rgltimer.Tick();
},
addSlider = function(min, max, step, value) {
var slider = document.createElement("input");
slider.type = "range";
slider.min = min;
slider.max = max;
slider.step = step;
slider.value = value;
slider.oninput = OnSliderInput;
slider.sliderActions = control.actions;
slider.sliderScene = this;
slider.className = "rgl-slider";
slider.id = el.id + "-slider";
el.rgltimer.Slider = slider;
slider.rgltimer = el.rgltimer;
el.appendChild(slider);
},
addLabel = function(labels, min, step, precision) {
var output = document.createElement("output");
output.sliderMin = min;
output.sliderStep = step;
output.outputPrecision = precision;
output.className = "rgl-label";
output.id = el.id + "-label";
el.rgltimer.Output = output;
el.rgltimer.outputLabels = labels;
el.appendChild(output);
},
addButton = function(label) {
var button = document.createElement("input"),
onclicks = {Reverse: function() { this.rgltimer.reverse();},
Play: function() { this.rgltimer.play();
this.value = this.rgltimer.enabled ? "Pause" : "Play"; },
Slower: function() { this.rgltimer.slower(); },
Faster: function() { this.rgltimer.faster(); },
Reset: function() { this.rgltimer.reset(); }};
button.rgltimer = el.rgltimer;
button.type = "button";
button.value = label;
if (label === "Play")
button.rgltimer.PlayButton = button;
button.onclick = onclicks[label];
button.className = "rgl-button";
button.id = el.id + "-" + label;
el.appendChild(button);
};
if (typeof control.reinit !== "undefined" && control.reinit !== null) {
control.actions.reinit = control.reinit;
}
el.rgltimer = new rgltimerClass(Tick, control.start, control.interval, control.stop, control.value, control.rate, control.loop, control.actions);
for (var i=0; i < components.length; i++) {
switch(components[i]) {
case "Slider": addSlider(control.start, control.stop,
control.step, control.value);
break;
case "Label": addLabel(control.labels, control.start,
control.step, control.precision);
break;
default:
addButton(components[i]);
}
}
el.rgltimer.Tick();
};
this.applyControls = function(el, x, draw) {
var self = this, reinit = x.reinit, i, control, type;
for (i = 0; i < x.length; i++) {
control = x[i];
type = control.type;
self[type](el, control);
}
if (typeof reinit !== "undefined" && reinit !== null) {
reinit = [].concat(reinit);
for (i = 0; i < reinit.length; i++)
self.getObj(reinit[i]).initialized = false;
}
if (typeof draw === "undefined" || draw)
self.drawScene();
};
this.sceneChangeHandler = function(message) {
var self = document.getElementById(message.elementId).rglinstance,
objs = message.objects, mat = message.material,
root = message.rootSubscene,
initSubs = message.initSubscenes,
redraw = message.redrawScene,
skipRedraw = message.skipRedraw,
deletes, subs, allsubs = [], i,j;
if (typeof message.delete !== "undefined") {
deletes = [].concat(message.delete);
if (typeof message.delfromSubscenes !== "undefined")
subs = [].concat(message.delfromSubscenes);
else
subs = [];
for (i = 0; i < deletes.length; i++) {
for (j = 0; j < subs.length; j++) {
self.delFromSubscene(deletes[i], subs[j]);
}
delete self.scene.objects[deletes[i]];
}
}
if (typeof objs !== "undefined") {
Object.keys(objs).forEach(function(key){
key = parseInt(key, 10);
self.scene.objects[key] = objs[key];
self.initObj(key);
var obj = self.getObj(key),
subs = [].concat(obj.inSubscenes), k;
allsubs = allsubs.concat(subs);
for (k = 0; k < subs.length; k++)
self.addToSubscene(key, subs[k]);
});
}
if (typeof mat !== "undefined") {
self.scene.material = mat;
}
if (typeof root !== "undefined") {
self.scene.rootSubscene = root;
}
if (typeof initSubs !== "undefined")
allsubs = allsubs.concat(initSubs);
allsubs = self.unique(allsubs);
for (i = 0; i < allsubs.length; i++) {
self.initSubscene(allsubs[i]);
}
if (typeof skipRedraw !== "undefined") {
root = self.getObj(self.scene.rootSubscene);
root.par3d.skipRedraw = skipRedraw;
}
if (redraw)
self.drawScene();
};
}).call(rglwidgetClass.prototype);
rgltimerClass = function(Tick, startTime, interval, stopTime, value, rate, loop, actions) {
this.enabled = false;
this.timerId = 0;
this.startTime = startTime;         /* nominal start time in seconds */
this.value = value;                 /* current nominal time */
this.interval = interval;           /* seconds between updates */
this.stopTime = stopTime;           /* nominal stop time */
this.rate = rate;                   /* nominal units per second */
this.loop = loop;                   /* "none", "cycle", or "oscillate" */
this.realStart = undefined;         /* real world start time */
this.multiplier = 1;                /* multiplier for fast-forward
or reverse */
this.actions = actions;
this.Tick = Tick;
};
(function() {
this.play = function() {
if (this.enabled) {
this.enabled = false;
window.clearInterval(this.timerId);
this.timerId = 0;
return;
}
var tick = function(self) {
var now = new Date();
self.value = self.multiplier*self.rate*(now - self.realStart)/1000 + self.startTime;
if (self.value > self.stopTime || self.value < self.startTime) {
if (!self.loop) {
self.reset();
} else {
var cycle = self.stopTime - self.startTime,
newval = (self.value - self.startTime) % cycle + self.startTime;
if (newval < self.startTime) {
newval += cycle;
}
self.realStart += (self.value - newval)*1000/self.multiplier/self.rate;
self.value = newval;
}
}
if (typeof self.Tick !== "undefined") {
self.Tick(self.value);
}
};
this.realStart = new Date() - 1000*(this.value - this.startTime)/this.rate/this.multiplier;
this.timerId = window.setInterval(tick, 1000*this.interval, this);
this.enabled = true;
};
this.reset = function() {
this.value = this.startTime;
this.newmultiplier(1);
if (typeof this.Tick !== "undefined") {
this.Tick(this.value);
}
if (this.enabled)
this.play();  /* really pause... */
if (typeof this.PlayButton !== "undefined")
this.PlayButton.value = "Play";
};
this.faster = function() {
this.newmultiplier(Math.SQRT2*this.multiplier);
};
this.slower = function() {
this.newmultiplier(this.multiplier/Math.SQRT2);
};
this.reverse = function() {
this.newmultiplier(-this.multiplier);
};
this.newmultiplier = function(newmult) {
if (newmult != this.multiplier) {
this.realStart += 1000*(this.value - this.startTime)/this.rate*(1/this.multiplier - 1/newmult);
this.multiplier = newmult;
}
};
}).call(rgltimerClass.prototype);</script><div id="unnamed_chunk_31div" class="rglWebGL">

</div>
<script type="text/javascript">
var unnamed_chunk_31div = document.getElementById("unnamed_chunk_31div"),
unnamed_chunk_31rgl = new rglwidgetClass();
unnamed_chunk_31div.width = 481;
unnamed_chunk_31div.height = 481;
unnamed_chunk_31rgl.initialize(unnamed_chunk_31div,
{"material":{"color":"#000000","alpha":1,"lit":true,"ambient":"#000000","specular":"#FFFFFF","emission":"#000000","shininess":50,"smooth":true,"front":"filled","back":"filled","size":3,"lwd":1,"fog":false,"point_antialias":false,"line_antialias":false,"texture":null,"textype":"rgb","texmipmap":false,"texminfilter":"linear","texmagfilter":"linear","texenvmap":false,"depth_mask":true,"depth_test":"less"},"rootSubscene":247,"objects":{"449":{"id":449,"type":"points","material":{"lit":false},"vertices":[[220.9866,100.987,146.3576],[228.4481,95.44614,144.9361],[227.5289,92.07558,147.0858],[250.5839,96.9143,138.6074],[250.3745,94.33936,137.6201],[263.8074,99.70576,122.8171],[266.2673,100.0974,118.3295],[266.7557,99.18455,116.4301],[272.032,104.9731,104.8673],[272.2923,104.1843,102.9673],[274.8044,102.8469,103.3135],[277.783,103.3639,103.3511],[272.7486,105.5809,104.1977],[278.9789,101.7888,99.9845],[278.7739,109.3905,104.3793],[282.1498,110.0038,105.4512],[224.7067,109.8636,153.5875],[229.6343,92.30637,157.297],[226.8855,90.36325,147.596],[249.8864,93.59079,136.778],[253.0099,90.94904,137.3492],[264.0801,98.5339,121.8946],[266.3223,98.73241,116.4656],[267.546,98.59859,112.8561],[271.0762,102.6729,100.8495],[274.6128,100.9206,103.2877],[277.392,102.1915,102.6947],[287.1214,101.4336,103.3074],[281.7958,96.63987,101.0807],[276.6551,95.09809,99.22113],[278.3287,113.7563,104.877],[282.3069,111.9321,105.6549],[289.5364,111.9601,109.1828],[186.866,132.7093,88.20393]],"colors":[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0.627451,0.1254902,0.9411765,1]],"centers":[[220.9866,100.987,146.3576],[228.4481,95.44614,144.9361],[227.5289,92.07558,147.0858],[250.5839,96.9143,138.6074],[250.3745,94.33936,137.6201],[263.8074,99.70576,122.8171],[266.2673,100.0974,118.3295],[266.7557,99.18455,116.4301],[272.032,104.9731,104.8673],[272.2923,104.1843,102.9673],[274.8044,102.8469,103.3135],[277.783,103.3639,103.3511],[272.7486,105.5809,104.1977],[278.9789,101.7888,99.9845],[278.7739,109.3905,104.3793],[282.1498,110.0038,105.4512],[224.7067,109.8636,153.5875],[229.6343,92.30637,157.297],[226.8855,90.36325,147.596],[249.8864,93.59079,136.778],[253.0099,90.94904,137.3492],[264.0801,98.5339,121.8946],[266.3223,98.73241,116.4656],[267.546,98.59859,112.8561],[271.0762,102.6729,100.8495],[274.6128,100.9206,103.2877],[277.392,102.1915,102.6947],[287.1214,101.4336,103.3074],[281.7958,96.63987,101.0807],[276.6551,95.09809,99.22113],[278.3287,113.7563,104.877],[282.3069,111.9321,105.6549],[289.5364,111.9601,109.1828],[186.866,132.7093,88.20393]],"ignoreExtent":false,"flags":0},"450":{"id":450,"type":"linestrip","material":{"lit":false},"vertices":[[186.866,132.7093,88.20393],[187.3355,131.1558,90.5968],[188.1165,130.2545,93.14326],[188.468,129.4757,94.97399],[188.2875,128.7542,97.45621],[188.2733,127.9567,99.16801],[188.4558,127.5704,101.5399],[188.9997,127.5399,103.6954],[189.6382,126.6176,104.954],[189.4185,126.1251,108.0766],[189.5984,125.0614,110.217],[190.1781,124.265,111.8775],[190.728,123.4797,113.6305],[190.9936,122.4563,116.2186],[191.1667,121.1412,118.8179],[191.5731,119.0004,121.6289],[192.2712,116.6221,122.8149],[193.0531,115.1163,125.2636],[194.7689,112.9951,128.0493],[195.9117,112.0142,129.4556],[197.1637,111.6175,131.9181],[198.8203,110.2031,133.3065],[199.9801,108.9401,134.3335],[201.4145,108.1221,136.2538],[202.6894,106.6835,136.0457],[205.341,105.6548,137.2315],[208.0497,104.1643,138.9636],[210.586,102.2778,140.5946],[212.5955,101.9351,143.8587],[215.2199,101.8055,144.2791],[217.4774,101.5081,144.3987],[219.168,101.1618,144.4411],[220.366,100.9909,145.3908],[220.9866,100.987,146.3576],["NaN","NaN","NaN"],[220.9866,100.987,146.3576],[221.8293,101.904,147.2064],[223.2953,103.0118,147.0665],[223.8867,104.3072,147.7834],[224.1486,105.1972,148.4997],[224.4773,106.7239,148.9979],[224.7513,108.0123,149.5417],[224.7584,109.0593,151.0719],[224.7067,109.8636,153.5875],["NaN","NaN","NaN"],[220.9866,100.987,146.3576],[222.1171,100.4789,145.4852],[223.4458,99.71291,145.6201],[225.1521,98.64415,144.8219],[225.7485,97.82787,144.8838],[227.328,96.536,144.9335],[228.4481,95.44614,144.9361],["NaN","NaN","NaN"],[228.4481,95.44614,144.9361],[228.3931,93.87876,145.0145],[227.9172,92.57701,146.1141],[227.5289,92.07558,147.0858],["NaN","NaN","NaN"],[227.5289,92.07558,147.0858],[228.1281,91.81482,146.9982],[228.6721,91.69865,147.8739],[229.1805,91.68178,148.7401],[228.6041,92.68944,152.5703],[228.843,92.8712,153.4464],[229.1483,92.56224,154.1649],[229.059,92.37194,156.5281],[229.6343,92.30637,157.297],["NaN","NaN","NaN"],[227.5289,92.07558,147.0858],[227.412,91.49557,146.982],[227.1017,91.09334,147.7889],[226.8855,90.36325,147.596],["NaN","NaN","NaN"],[228.4481,95.44614,144.9361],[231.0242,95.31286,144.8492],[232.3152,94.80954,144.8533],[234.1503,94.19541,144.0023],[235.5957,94.06973,144.0858],[237.8952,94.37737,143.305],[238.8612,94.80431,143.307],[239.9644,94.7758,142.4694],[241.3587,95.06895,141.6749],[243.9267,95.56536,140.2738],[246.2103,96.29207,139.034],[247.157,96.62735,138.4089],[248.542,96.75484,138.5082],[250.5839,96.9143,138.6074],["NaN","NaN","NaN"],[250.5839,96.9143,138.6074],[250.4272,95.98822,138.5313],[250.2206,95.00672,138.4405],[250.3745,94.33936,137.6201],["NaN","NaN","NaN"],[250.3745,94.33936,137.6201],[249.9186,94.05761,137.5855],[249.8864,93.59079,136.778],["NaN","NaN","NaN"],[250.3745,94.33936,137.6201],[250.7898,93.72993,137.5932],[251.1502,92.9019,137.5457],[251.7909,91.71586,137.4462],[252.5904,91.09129,137.3698],[253.0099,90.94904,137.3492],["NaN","NaN","NaN"],[250.5839,96.9143,138.6074],[252.0321,97.33591,138.6274],[253.2899,97.58426,137.76],[254.7626,97.8494,136.7945],[256.0359,98.47311,135.7194],[257.7767,99.34311,134.4333],[259.1145,100.36,134.0954],[260.3564,100.7826,132.792],[261.7495,100.9496,129.3055],[262.4966,100.3415,127.2079],[263.8074,99.70576,122.8171],["NaN","NaN","NaN"],[263.8074,99.70576,122.8171],[264.0801,98.5339,121.8946],["NaN","NaN","NaN"],[263.8074,99.70576,122.8171],[265.1373,100.227,120.4506],[266.2673,100.0974,118.3295],["NaN","NaN","NaN"],[266.2673,100.0974,118.3295],[266.7557,99.18455,116.4301],["NaN","NaN","NaN"],[266.7557,99.18455,116.4301],[266.3223,98.73241,116.4656],["NaN","NaN","NaN"],[266.7557,99.18455,116.4301],[267.2516,98.61651,112.853],[267.546,98.59859,112.8561],["NaN","NaN","NaN"],[266.2673,100.0974,118.3295],[267.8407,100.284,113.6377],[268.5302,101.2489,110.4057],[269.1459,102.6101,108.2586],[270.2014,104.1951,106.2789],[271.0768,104.9522,106.2173],[272.032,104.9731,104.8673],["NaN","NaN","NaN"],[272.032,104.9731,104.8673],[272.2923,104.1843,102.9673],["NaN","NaN","NaN"],[272.2923,104.1843,102.9673],[271.5912,103.5824,103.0344],[271.1117,102.9115,101.9248],[271.0762,102.6729,100.8495],["NaN","NaN","NaN"],[272.2923,104.1843,102.9673],[272.8246,103.8287,104.7537],[273.6577,103.4428,104.0345],[274.8044,102.8469,103.3135],["NaN","NaN","NaN"],[274.8044,102.8469,103.3135],[274.7829,101.7907,103.2918],[274.6128,100.9206,103.2877],["NaN","NaN","NaN"],[274.8044,102.8469,103.3135],[275.8587,103.0875,103.294],[277.783,103.3639,103.3511],["NaN","NaN","NaN"],[277.783,103.3639,103.3511],[277.6615,102.721,103.3308],[277.392,102.1915,102.6947],["NaN","NaN","NaN"],[277.783,103.3639,103.3511],[278.595,103.4609,103.4094],[279.563,103.6426,103.5104],[280.5097,104.0509,103.0457],[281.4014,104.6174,103.1989],[282.0585,104.9431,103.9054],[283.2689,104.9636,104.1276],[284.4193,104.2881,103.7481],[285.1795,103.7343,102.7591],[285.8599,103.4765,102.9102],[286.4616,103.0286,103.6455],[286.8797,102.6475,103.7644],[287.0918,102.0288,103.2655],[287.1214,101.4336,103.3074],["NaN","NaN","NaN"],[272.032,104.9731,104.8673],[272.7486,105.5809,104.1977],["NaN","NaN","NaN"],[272.7486,105.5809,104.1977],[273.3673,106.4848,102.9745],[274.6024,106.7613,102.3191],[275.4419,106.1793,101.6652],[276.2544,106.0721,101.0881],[276.774,105.311,101.6091],[277.4392,104.2161,101.0135],[278.09,103.4409,101.0319],[278.9789,101.7888,99.9845],["NaN","NaN","NaN"],[278.9789,101.7888,99.9845],[279.8912,100.9907,99.55326],[280.5293,100.0932,100.1923],[281.1848,99.09615,101.4213],[281.6648,97.49535,101.0133],[281.7958,96.63987,101.0807],["NaN","NaN","NaN"],[278.9789,101.7888,99.9845],[278.3321,100.1545,98.81785],[277.7251,99.09983,98.76931],[277.4498,98.20747,98.74865],[277.0392,97.1171,99.26762],[277.0078,95.74657,99.24362],[276.6551,95.09809,99.22113],["NaN","NaN","NaN"],[272.7486,105.5809,104.1977],[273.9125,106.1373,102.9045],[274.762,107.0453,102.9158],[276.1546,107.9018,103.5491],[277.2304,108.2857,104.198],[278.2249,109.0334,104.3084],[278.7739,109.3905,104.3793],["NaN","NaN","NaN"],[278.7739,109.3905,104.3793],[278.7235,110.4274,103.9013],[278.4662,111.5342,104.5861],[278.113,112.6423,104.7063],[278.0377,113.3694,104.8016],[278.3287,113.7563,104.877],["NaN","NaN","NaN"],[278.7739,109.3905,104.3793],[279.69,109.3976,104.4651],[280.6721,109.5932,104.5958],[281.5898,109.8331,105.3493],[282.1498,110.0038,105.4512],["NaN","NaN","NaN"],[282.1498,110.0038,105.4512],[282.1288,110.7525,105.5135],[282.2892,111.4906,105.6074],[282.3069,111.9321,105.6549],["NaN","NaN","NaN"],[282.1498,110.0038,105.4512],[282.8857,109.9996,105.5739],[284.0089,109.7155,106.3845],[284.9341,109.5795,107.1947],[285.779,109.8077,108.0141],[286.976,109.9177,108.2203],[288.1162,110.6115,109.0588],[288.5916,110.9776,108.4278],[289.5364,111.9601,109.1828],["NaN","NaN","NaN"]],"colors":[[1,0,0,1]],"centers":[[186.866,132.7093,88.20393],[187.3355,131.1558,90.5968],[188.1165,130.2545,93.14326],[188.468,129.4757,94.97399],[188.2875,128.7542,97.45621],[188.2733,127.9567,99.16801],[188.4558,127.5704,101.5399],[188.9997,127.5399,103.6954],[189.6382,126.6176,104.954],[189.4185,126.1251,108.0766],[189.5984,125.0614,110.217],[190.1781,124.265,111.8775],[190.728,123.4797,113.6305],[190.9936,122.4563,116.2186],[191.1667,121.1412,118.8179],[191.5731,119.0004,121.6289],[192.2712,116.6221,122.8149],[193.0531,115.1163,125.2636],[194.7689,112.9951,128.0493],[195.9117,112.0142,129.4556],[197.1637,111.6175,131.9181],[198.8203,110.2031,133.3065],[199.9801,108.9401,134.3335],[201.4145,108.1221,136.2538],[202.6894,106.6835,136.0457],[205.341,105.6548,137.2315],[208.0497,104.1643,138.9636],[210.586,102.2778,140.5946],[212.5955,101.9351,143.8587],[215.2199,101.8055,144.2791],[217.4774,101.5081,144.3987],[219.168,101.1618,144.4411],[220.366,100.9909,145.3908],[220.9866,100.987,146.3576],["NaN","NaN","NaN"],[220.9866,100.987,146.3576],[221.8293,101.904,147.2064],[223.2953,103.0118,147.0665],[223.8867,104.3072,147.7834],[224.1486,105.1972,148.4997],[224.4773,106.7239,148.9979],[224.7513,108.0123,149.5417],[224.7584,109.0593,151.0719],[224.7067,109.8636,153.5875],["NaN","NaN","NaN"],[220.9866,100.987,146.3576],[222.1171,100.4789,145.4852],[223.4458,99.71291,145.6201],[225.1521,98.64415,144.8219],[225.7485,97.82787,144.8838],[227.328,96.536,144.9335],[228.4481,95.44614,144.9361],["NaN","NaN","NaN"],[228.4481,95.44614,144.9361],[228.3931,93.87876,145.0145],[227.9172,92.57701,146.1141],[227.5289,92.07558,147.0858],["NaN","NaN","NaN"],[227.5289,92.07558,147.0858],[228.1281,91.81482,146.9982],[228.6721,91.69865,147.8739],[229.1805,91.68178,148.7401],[228.6041,92.68944,152.5703],[228.843,92.8712,153.4464],[229.1483,92.56224,154.1649],[229.059,92.37194,156.5281],[229.6343,92.30637,157.297],["NaN","NaN","NaN"],[227.5289,92.07558,147.0858],[227.412,91.49557,146.982],[227.1017,91.09334,147.7889],[226.8855,90.36325,147.596],["NaN","NaN","NaN"],[228.4481,95.44614,144.9361],[231.0242,95.31286,144.8492],[232.3152,94.80954,144.8533],[234.1503,94.19541,144.0023],[235.5957,94.06973,144.0858],[237.8952,94.37737,143.305],[238.8612,94.80431,143.307],[239.9644,94.7758,142.4694],[241.3587,95.06895,141.6749],[243.9267,95.56536,140.2738],[246.2103,96.29207,139.034],[247.157,96.62735,138.4089],[248.542,96.75484,138.5082],[250.5839,96.9143,138.6074],["NaN","NaN","NaN"],[250.5839,96.9143,138.6074],[250.4272,95.98822,138.5313],[250.2206,95.00672,138.4405],[250.3745,94.33936,137.6201],["NaN","NaN","NaN"],[250.3745,94.33936,137.6201],[249.9186,94.05761,137.5855],[249.8864,93.59079,136.778],["NaN","NaN","NaN"],[250.3745,94.33936,137.6201],[250.7898,93.72993,137.5932],[251.1502,92.9019,137.5457],[251.7909,91.71586,137.4462],[252.5904,91.09129,137.3698],[253.0099,90.94904,137.3492],["NaN","NaN","NaN"],[250.5839,96.9143,138.6074],[252.0321,97.33591,138.6274],[253.2899,97.58426,137.76],[254.7626,97.8494,136.7945],[256.0359,98.47311,135.7194],[257.7767,99.34311,134.4333],[259.1145,100.36,134.0954],[260.3564,100.7826,132.792],[261.7495,100.9496,129.3055],[262.4966,100.3415,127.2079],[263.8074,99.70576,122.8171],["NaN","NaN","NaN"],[263.8074,99.70576,122.8171],[264.0801,98.5339,121.8946],["NaN","NaN","NaN"],[263.8074,99.70576,122.8171],[265.1373,100.227,120.4506],[266.2673,100.0974,118.3295],["NaN","NaN","NaN"],[266.2673,100.0974,118.3295],[266.7557,99.18455,116.4301],["NaN","NaN","NaN"],[266.7557,99.18455,116.4301],[266.3223,98.73241,116.4656],["NaN","NaN","NaN"],[266.7557,99.18455,116.4301],[267.2516,98.61651,112.853],[267.546,98.59859,112.8561],["NaN","NaN","NaN"],[266.2673,100.0974,118.3295],[267.8407,100.284,113.6377],[268.5302,101.2489,110.4057],[269.1459,102.6101,108.2586],[270.2014,104.1951,106.2789],[271.0768,104.9522,106.2173],[272.032,104.9731,104.8673],["NaN","NaN","NaN"],[272.032,104.9731,104.8673],[272.2923,104.1843,102.9673],["NaN","NaN","NaN"],[272.2923,104.1843,102.9673],[271.5912,103.5824,103.0344],[271.1117,102.9115,101.9248],[271.0762,102.6729,100.8495],["NaN","NaN","NaN"],[272.2923,104.1843,102.9673],[272.8246,103.8287,104.7537],[273.6577,103.4428,104.0345],[274.8044,102.8469,103.3135],["NaN","NaN","NaN"],[274.8044,102.8469,103.3135],[274.7829,101.7907,103.2918],[274.6128,100.9206,103.2877],["NaN","NaN","NaN"],[274.8044,102.8469,103.3135],[275.8587,103.0875,103.294],[277.783,103.3639,103.3511],["NaN","NaN","NaN"],[277.783,103.3639,103.3511],[277.6615,102.721,103.3308],[277.392,102.1915,102.6947],["NaN","NaN","NaN"],[277.783,103.3639,103.3511],[278.595,103.4609,103.4094],[279.563,103.6426,103.5104],[280.5097,104.0509,103.0457],[281.4014,104.6174,103.1989],[282.0585,104.9431,103.9054],[283.2689,104.9636,104.1276],[284.4193,104.2881,103.7481],[285.1795,103.7343,102.7591],[285.8599,103.4765,102.9102],[286.4616,103.0286,103.6455],[286.8797,102.6475,103.7644],[287.0918,102.0288,103.2655],[287.1214,101.4336,103.3074],["NaN","NaN","NaN"],[272.032,104.9731,104.8673],[272.7486,105.5809,104.1977],["NaN","NaN","NaN"],[272.7486,105.5809,104.1977],[273.3673,106.4848,102.9745],[274.6024,106.7613,102.3191],[275.4419,106.1793,101.6652],[276.2544,106.0721,101.0881],[276.774,105.311,101.6091],[277.4392,104.2161,101.0135],[278.09,103.4409,101.0319],[278.9789,101.7888,99.9845],["NaN","NaN","NaN"],[278.9789,101.7888,99.9845],[279.8912,100.9907,99.55326],[280.5293,100.0932,100.1923],[281.1848,99.09615,101.4213],[281.6648,97.49535,101.0133],[281.7958,96.63987,101.0807],["NaN","NaN","NaN"],[278.9789,101.7888,99.9845],[278.3321,100.1545,98.81785],[277.7251,99.09983,98.76931],[277.4498,98.20747,98.74865],[277.0392,97.1171,99.26762],[277.0078,95.74657,99.24362],[276.6551,95.09809,99.22113],["NaN","NaN","NaN"],[272.7486,105.5809,104.1977],[273.9125,106.1373,102.9045],[274.762,107.0453,102.9158],[276.1546,107.9018,103.5491],[277.2304,108.2857,104.198],[278.2249,109.0334,104.3084],[278.7739,109.3905,104.3793],["NaN","NaN","NaN"],[278.7739,109.3905,104.3793],[278.7235,110.4274,103.9013],[278.4662,111.5342,104.5861],[278.113,112.6423,104.7063],[278.0377,113.3694,104.8016],[278.3287,113.7563,104.877],["NaN","NaN","NaN"],[278.7739,109.3905,104.3793],[279.69,109.3976,104.4651],[280.6721,109.5932,104.5958],[281.5898,109.8331,105.3493],[282.1498,110.0038,105.4512],["NaN","NaN","NaN"],[282.1498,110.0038,105.4512],[282.1288,110.7525,105.5135],[282.2892,111.4906,105.6074],[282.3069,111.9321,105.6549],["NaN","NaN","NaN"],[282.1498,110.0038,105.4512],[282.8857,109.9996,105.5739],[284.0089,109.7155,106.3845],[284.9341,109.5795,107.1947],[285.779,109.8077,108.0141],[286.976,109.9177,108.2203],[288.1162,110.6115,109.0588],[288.5916,110.9776,108.4278],[289.5364,111.9601,109.1828],["NaN","NaN","NaN"]],"ignoreExtent":false,"flags":128},"251":{"id":251,"type":"light","vertices":[[0,0,1]],"colors":[[1,1,1,1],[1,1,1,1],[1,1,1,1]],"viewpoint":true,"finite":false},"250":{"id":250,"type":"background","material":{"fog":true},"colors":[[0.2980392,0.2980392,0.2980392,1]],"centers":[[0,0,0]],"sphere":false,"fogtype":"none","flags":0},"252":{"id":252,"type":"background","material":{"lit":false,"back":"lines"},"colors":[[1,1,1,1]],"centers":[[0,0,0]],"sphere":false,"fogtype":"none","flags":0},"451":{"id":451,"type":"background","material":{"lit":false,"back":"lines"},"colors":[[0.827451,0.827451,0.827451,1]],"centers":[[0,0,0]],"sphere":false,"fogtype":"none","flags":0},"247":{"id":247,"type":"subscene","par3d":{"antialias":8,"FOV":30,"ignoreExtent":false,"listeners":247,"mouseMode":{"left":"trackball","right":"zoom","middle":"fov","wheel":"pull"},"observer":[0,0,252.6833],"modelMatrix":[[1,0,0,-238.2012],[0,0.3420202,0.9396926,-153.4954],[0,-0.9396926,0.3420202,-189.8566],[0,0,0,1]],"projMatrix":[[3.732051,0,0,0],[0,3.732051,0,0],[0,0,-3.863704,-910.8941],[0,0,-1,0]],"skipRedraw":false,"userMatrix":[[1,0,0,0],[0,0.3420201,0.9396926,0],[0,-0.9396926,0.3420201,0],[0,0,0,1]],"scale":[1,1,1],"viewport":{"x":0,"y":0,"width":1,"height":1},"zoom":1,"bbox":[186.866,289.5364,90.36325,132.7093,88.20393,157.297],"windowRect":[64,104,544,584],"family":"sans","font":1,"cex":1,"useFreeType":true,"fontname":"/Library/Frameworks/R.framework/Versions/3.3/Resources/library/rgl/fonts/FreeSans.ttf","maxClipPlanes":6},"embeddings":{"viewport":"replace","projection":"replace","model":"replace"},"objects":[451,449,450,251],"subscenes":[],"flags":1152}},"snapshot":"data:image/png;base64,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","width":481,"height":481,"sphereVerts":{"vb":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,0.9807853,0.9238795,0.8314696,0.7071068,0.5555702,0.3826834,0.1950903,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1950903,-0.3826834,-0.5555702,-0.7071068,-0.8314696,-0.9238795,-0.9807853,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1],[0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,0.9807853,0.9238795,0.8314696,0.7071068,0.5555702,0.3826834,0.1950903,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1950903,-0.3826834,-0.5555702,-0.7071068,-0.8314696,-0.9238795,-0.9807853,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,0.9807853,0.9238795,0.8314696,0.7071068,0.5555702,0.3826834,0.1950903,0]],"it":[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270],[17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288],[18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271]],"primitivetype":"triangle","material":null,"normals":null,"texcoords":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1]]}});
unnamed_chunk_31rgl.prefix = "unnamed_chunk_31";
</script><p id="unnamed_chunk_31debug">
You must enable Javascript to view this page properly.
</p>
<script>unnamed_chunk_31rgl.start();</script><p>You should be able to rotate (click and drag) and zoom (mouse wheel) this figure.</p>
<p>Since this results in quite large html files when used with many neurons, we will not use it further here. For now let&rsquo;s show a plot in which we both select a subset of neurons and colour them according to their glomerulus of origin.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 3d plot of neurons from olfactory glomeruli beginning with a D</span>
<span class="co"># coloured by glomerulus</span>
rval=<span class="kw"><a href="../reference/plot3d.html">plot3d</a></span>(Cell07PNs, <span class="dt">subset=</span><span class="kw">grepl</span>(<span class="st">"^D"</span>, Glomerulus), <span class="dt">col=</span>Glomerulus,
  <span class="dt">lwd=</span><span class="dv">2</span>, <span class="dt">WithNodes=</span><span class="ot">FALSE</span>)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-32-1.png" width="576"></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># make a legend so that you know which colours match which glomerulus</span>
<span class="kw">plot.new</span>()
<span class="kw"><a href="../reference/neuronlist-dataframe-methods.html">with</a></span>(<span class="kw">attr</span>(rval,<span class="st">'df'</span>), <span class="kw">legend</span>(<span class="st">'center'</span>, <span class="dt">legend =</span> <span class="kw">unique</span>(Glomerulus), <span class="dt">fill=</span><span class="kw">unique</span>(col)))</code></pre>
<p><img src="neurons-intro_files/figure-html/plot3d-legend-1.png" width="192"></p>
</div>
</div>
<div id="putting-it-all-together" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#putting-it-all-together" class="anchor"> </a></body></html>Putting it all together</h2>
<p>To close this tutorial, let&rsquo;s do some morphological analysis of the neurons in this dataset. There are second order olfactory projection neurons originating from 4 different glomeruli in the <code>Cell07PNs</code> sample dataset, each coming from a different animal. We can ask whether their axon terminal arborisations in a brain area called the lateral horn show any features that are distinctive for different classes. This would be consistent with the hypothesis that information from different glomeruli (i.e.&nbsp;olfactory channels) is handled in a stereotyped way in this brain area.</p>
<p>Let&rsquo;s start by cutting out the arbour within the lateral horn from all of the neurons. We&rsquo;ll use a very simple approach of cutting at X=250, although <strong>nat</strong> has more sophisticated ways to do this e.g.&nbsp;by using 3D spaces defined by a surface mesh.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># note that we had to use OmitFailures=T due to a problem with the graph</span>
<span class="co"># structure of one neuron</span>
lha=<span class="kw"><a href="../reference/nlapply.html">nlapply</a></span>(Cell07PNs, subset, X&gt;<span class="dv">250</span>, <span class="dt">OmitFailures =</span> T)
<span class="co"># Let's plot what we have colouring by glomerulus</span>
<span class="kw">plot</span>(lha, <span class="dt">col=</span>Glomerulus, <span class="dt">WithNodes=</span>F)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-33-1.png" width="480"></p>
<p>Now we can get a basic statistical summary by axon arbour.</p>
<pre class="sourceCode r"><code class="sourceCode r">lhstats=<span class="kw"><a href="../reference/summary.neuronlist.html">summary</a></span>(lha, <span class="dt">include.attached.dataframe =</span> <span class="ot">TRUE</span>)
<span class="kw">boxplot</span>(lhstats$cable.length~lhstats$Glomerulus, <span class="dt">log=</span><span class="st">'y'</span>)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-34-1.png" width="480"></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">boxplot</span>(lhstats$branchpoints~lhstats$Glomerulus)</code></pre>
<p><img src="neurons-intro_files/figure-html/unnamed-chunk-34-2.png" width="480"></p>
<p>We can also calculate the median position of the arbour for each neuron and add that to the lhstats database</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># quick function to calculate centroid</span>
arbour_centroid &lt;-<span class="st"> </span>function(n) {
  <span class="co"># extract location of all points in neuron object</span>
  xyzs=<span class="kw"><a href="../reference/xyzmatrix.html">xyzmatrix</a></span>(n)
  <span class="co"># median in all 3 axes (=&gt;2 columns)</span>
  <span class="kw">apply</span>(xyzs, <span class="dv">2</span>, median)
}
<span class="co"># note that we have to transpose because sapply results in x,y,z rows</span>
centroids=<span class="kw">t</span>(<span class="kw">sapply</span>(lha, arbour_centroid))
lhstats=<span class="kw">cbind</span>(lhstats, centroids)</code></pre>
<p>Finally we can take these data and see how well we can predict the identity of the neuron (i.e.&nbsp;its glomerulus) based on the statistics of the axon arbour in the lateral horn. We use the linear discriminant analysis (provided by the function <code>lda</code> in recommended package <code>MASS</code>). This also runs a leave one out cross-validation to get a more robust initial estimate of prediction error.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MASS)
lda.fit =<span class="st"> </span><span class="kw">lda</span>(Glomerulus ~<span class="st"> </span>cable.length+X+Y+Z+branchpoints, lhstats, <span class="dt">CV =</span> T)
<span class="kw">table</span>(lda.fit$class, lhstats$Glomerulus)</code></pre>
<pre><code>##       
##        DA1 DL3 DP1m VA1d
##   DA1   10   2    0    1
##   DL3    0   7    0    0
##   DP1m   0   0    8    0
##   VA1d   1   0    0   10</code></pre>
<p>The prediction accuracy of 35/39 i.e.&nbsp;just under 90% is already very good compared with a chance level of about 25% for these 4 classes.</p>
</div>
<div id="learning-more" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#learning-more" class="anchor"> </a></body></html>Learning More</h2>
<p>We hope this tutorial will provide you with a good foundation for further use of the <strong>nat</strong> and related packages. Please visit the main <a href="http://jefferis.github.io/nat/index.html">nat README</a> for suggestions of resources to learn more and solve problems. You may also find that some time spent reading Hadley Wickham&rsquo;s <a href="http://adv-r.had.co.nz/">Advanced R</a> is a worthwhile investment. I recommend the first 7 chapters (Introduction to OO field guide) as material that will be helpful for anyone who intends to carry out a significant project using R.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#preface">Preface</a></li>
      <li><a href="#startup">Startup</a></li>
      <li><a href="#neurons-and-neuronlists">Neurons and Neuronlists</a></li>
      <li><a href="#neurons">Neurons</a></li>
      <li><a href="#neuronlists">Neuronlists</a></li>
      <li><a href="#plots">Plots</a></li>
      <li><a href="#putting-it-all-together">Putting it all together</a></li>
      <li><a href="#learning-more">Learning More</a></li>
      </ul></div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Gregory Jefferis, James Manton.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer></div>

  </body></html>
